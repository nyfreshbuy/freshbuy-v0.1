<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>è¥é”€ä¸­å¿ƒ - åœ¨é²œè´­æ‹¼å¥½è´§åå°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/css/admin.css" />

    <!-- è¥é”€ä¸­å¿ƒæ·±è‰²ä¸»é¢˜ï¼ˆè·Ÿç»“ç®—ç®¡ç†é£æ ¼ä¸€è‡´ï¼‰ -->
    <style>
      /* é¡¶éƒ¨ 4 ä¸ª KPI å¡ç‰‡ï¼Œé£æ ¼ç±»ä¼¼ç»“ç®—ç®¡ç† */
      .mc-kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 16px;
        margin-bottom: 18px;
      }
      @media (max-width: 1100px) {
        .mc-kpi-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 720px) {
        .mc-kpi-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }
      .mc-kpi-card {
        border-radius: 18px;
        padding: 14px 16px;
        background: radial-gradient(circle at top left, #1f2937, #020617);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.65);
      }
      .mc-kpi-title {
        font-size: 13px;
        color: #9ca3af;
        margin-bottom: 6px;
      }
      .mc-kpi-value {
        font-size: 22px;
        font-weight: 600;
        color: #e5e7eb;
        margin-bottom: 4px;
      }
      .mc-kpi-sub {
        font-size: 11px;
        color: #6b7280;
      }

      /* Tabs */
      .mc-tabs {
        display: inline-flex;
        padding: 4px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(75, 85, 99, 0.8);
        gap: 4px;
        margin-bottom: 16px;
      }
      .mc-tab-btn {
        padding: 6px 14px;
        border-radius: 999px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 12px;
        color: #9ca3af;
        white-space: nowrap;
      }
      .mc-tab-btn.active {
        background: linear-gradient(135deg, #2563eb, #38bdf8);
        color: #f9fafb;
        box-shadow: 0 0 12px rgba(37, 99, 235, 0.8);
      }
      .mc-tab-pane {
        display: none;
      }
      .mc-tab-pane.active {
        display: block;
      }

      /* æ·±è‰²å¡ç‰‡åŒºåŸŸ */
      .mc-card {
        background: rgba(15, 23, 42, 0.96);
        border-radius: 16px;
        padding: 14px 16px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        box-shadow: 0 16px 36px rgba(15, 23, 42, 0.8);
        margin-bottom: 14px;
      }
      .mc-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }
      .mc-card-title {
        font-size: 14px;
        font-weight: 500;
        color: #e5e7eb;
        margin-bottom: 2px;
      }
      .mc-card-sub {
        font-size: 11px;
        color: #6b7280;
      }

      .mc-form-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
      .mc-form-row label {
        font-size: 11px;
        color: #9ca3af;
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      .mc-form-row input,
      .mc-form-row select,
      .mc-form-row textarea {
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        min-width: 120px;
        font-size: 12px;
        background: #020617;
        color: #e5e7eb;
      }
      .mc-form-row input::placeholder,
      .mc-form-row textarea::placeholder {
        color: #4b5563;
      }

      .mc-btn-primary {
        padding: 6px 16px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #2563eb, #22c55e);
        color: #f9fafb;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.75);
      }
      .mc-btn-outline {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #6b7280;
        background: transparent;
        color: #e5e7eb;
        font-size: 11px;
        cursor: pointer;
      }
      .mc-btn-danger {
        padding: 4px 10px;
        border-radius: 999px;
        border: none;
        background: #ef4444;
        color: #f9fafb;
        font-size: 11px;
        cursor: pointer;
      }

      .mc-table-wrapper {
        overflow-x: auto;
      }
      .mc-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      .mc-table th,
      .mc-table td {
        border-bottom: 1px solid #1f2937;
        padding: 6px 4px;
        text-align: left;
        white-space: nowrap;
      }
      .mc-table th {
        color: #9ca3af;
        font-weight: 500;
      }
      .mc-table td {
        color: #e5e7eb;
      }

      .mc-pill {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
      }
      .mc-pill-green {
        background: rgba(34, 197, 94, 0.16);
        color: #4ade80;
      }
      .mc-pill-gray {
        background: rgba(148, 163, 184, 0.16);
        color: #e5e7eb;
      }

      .mc-layout-2col {
        display: grid;
        grid-template-columns: 2fr 1.6fr;
        gap: 16px;
      }
      @media (max-width: 1100px) {
        .mc-layout-2col {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      /* ç§’æ€å•†å“æœç´¢ä¸‹æ‹‰ */
      .mc-suggest-wrap {
        position: relative;
      }
      .mc-suggest-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #020617;
        border-radius: 10px;
        border: 1px solid #4b5563;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
        z-index: 99;
        display: none;
      }
      .mc-suggest-item {
        padding: 6px 8px;
        font-size: 12px;
        color: #e5e7eb;
        cursor: pointer;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .mc-suggest-item:hover {
        background: rgba(37, 99, 235, 0.7);
      }
      .mc-suggest-empty {
        padding: 6px 8px;
        font-size: 12px;
        color: #6b7280;
      }
    </style>
  </head>

  <body data-page="marketing">
    <div class="admin-layout">
      <!-- ä¾§è¾¹æ  -->
      <aside class="admin-sidebar">
      <!-- âœ… ç»Ÿä¸€ sidebarï¼šç”± /admin/assets/js/admin_sidebar.js æ³¨å…¥ -->
      <div id="adminSidebar"></div>
    </aside>
      <!-- ä¸»åŒºåŸŸ -->
      <div class="admin-main">
        <header class="admin-topbar">
          <button class="admin-btn admin-btn-ghost" data-toggle-sidebar>
            â˜°
          </button>
          <div class="admin-topbar-title">è¥é”€ä¸­å¿ƒ</div>
          <div class="admin-topbar-spacer"></div>

          <div class="admin-search">
            <span class="admin-search-icon">ğŸ”</span>
            <input type="text" placeholder="æœç´¢æ´»åŠ¨ / ä¼˜æƒ åˆ¸..." />
          </div>

          <div class="admin-user">
            <div class="admin-user-avatar">A</div>
            <div class="admin-user-info">
              <span class="admin-user-name">Admin</span>
              <span class="admin-user-role">è¶…çº§ç®¡ç†å‘˜</span>
            </div>
          </div>
        </header>

        <main class="admin-content">
          <!-- é¡¶éƒ¨æ ‡é¢˜ + æ“ä½œ -->
          <div class="admin-page-header">
            <div>
              <div class="admin-page-title">è¥é”€æ€»è§ˆ</div>
              <div class="admin-breadcrumb">åå° &gt; è¥é”€ä¸­å¿ƒ</div>
            </div>
            <div class="admin-page-actions">
              <button class="admin-btn admin-btn-ghost">å¯¼å‡ºæ´»åŠ¨æ•°æ®</button>
              <button class="admin-btn admin-btn-primary">ï¼‹ åˆ›å»ºè¥é”€æ´»åŠ¨</button>
            </div>
          </div>

          <!-- é¡¶éƒ¨ 4 ä¸ªç»Ÿè®¡å¡ç‰‡ï¼ˆç¤ºä¾‹ï¼‰ -->
          <section class="mc-kpi-grid">
            <article class="mc-kpi-card">
              <div class="mc-kpi-title">è¿›è¡Œä¸­æ´»åŠ¨</div>
              <div class="mc-kpi-value">3</div>
              <div class="mc-kpi-sub">æœ¬å‘¨çˆ†å“æ—¥ / é¦–å•åˆ¸ / æ‹¼è¿è´¹æ´»åŠ¨</div>
            </article>
            <article class="mc-kpi-card">
              <div class="mc-kpi-title">æœ¬æœˆå‘æ”¾ä¼˜æƒ åˆ¸</div>
              <div class="mc-kpi-value">1,280 å¼ </div>
              <div class="mc-kpi-sub">å·²æ ¸é”€ 436 å¼  Â· æ ¸é”€ç‡ 34.1%</div>
            </article>
            <article class="mc-kpi-card">
              <div class="mc-kpi-title">è¥é”€æ‹‰åŠ¨ GMV</div>
              <div class="mc-kpi-value">$12,430</div>
              <div class="mc-kpi-sub">å æ•´ä½“ GMV çš„ 19.6%</div>
            </article>
            <article class="mc-kpi-card">
              <div class="mc-kpi-title">å¥½å‹æ‹¼å•è®¢å•æ•°</div>
              <div class="mc-kpi-value">86</div>
              <div class="mc-kpi-sub">åˆ†äº«æˆäº¤å æ¯” 26.5%</div>
            </article>
          </section>

          <!-- Tabs + å†…å®¹ -->
          <section class="mc-layout-2col">
            <div>
              <!-- Tabs å¡ç‰‡ -->
              <div class="mc-card" style="padding-bottom: 10px">
                <div class="mc-card-header">
                  <div>
                    <div class="mc-card-title">è¥é”€è§„åˆ™é…ç½®</div>
                    <div class="mc-card-sub">
                      åœ¨è¿™é‡Œç»Ÿä¸€é…ç½®ä¼˜æƒ åˆ¸ / æ»¡å‡ / æ‹¼è¿è´¹ / ç§’æ€ / ç§¯åˆ†ç­‰è§„åˆ™ã€‚
                    </div>
                  </div>
                  <div class="mc-tabs">
                    <button class="mc-tab-btn active" data-tab="coupon">
                      ä¼˜æƒ åˆ¸
                    </button>
                    <button class="mc-tab-btn" data-tab="promotion">
                      æ»¡å‡
                    </button>
                    <button class="mc-tab-btn" data-tab="share">
                      æ‹¼è¿è´¹
                    </button>
                    <button class="mc-tab-btn" data-tab="flash">
                      ç§’æ€
                    </button>
                    <button class="mc-tab-btn" data-tab="points">
                      ç§¯åˆ†
                    </button>
                  </div>
                </div>

                <!-- ========== ä¼˜æƒ åˆ¸ ========== -->
                <section class="mc-tab-pane active" id="mc-tab-coupon">
                  <article style="margin-bottom: 10px">
                    <div class="mc-form-row">
                      <label>
                        åç§°
                        <input id="coupon_title" placeholder="æ–°å®¢ç«‹å‡ $5" />
                      </label>
                      <label>
                        ç±»å‹
                        <select id="coupon_type">
                          <option value="cash">ç°é‡‘åˆ¸</option>
                          <option value="percentage">æŠ˜æ‰£åˆ¸</option>
                          <option value="fullcut">æ»¡å‡åˆ¸</option>
                          <option value="newUser">æ–°å®¢ç¤¼åˆ¸</option>
                        </select>
                      </label>
                      <label>
                        é‡‘é¢/æŠ˜æ‰£
                        <input
                          id="coupon_amount"
                          type="number"
                          step="0.01"
                          placeholder="5 æˆ– 10(%)"
                        />
                      </label>
                      <label>
                        ä½¿ç”¨é—¨æ§›
                        <input
                          id="coupon_minSpend"
                          type="number"
                          step="0.01"
                          placeholder="0 ä¸ºæ— é—¨æ§›"
                        />
                      </label>
                    </div>
                    <div class="mc-form-row">
                      <label>
                        ç”Ÿæ•ˆæ—¶é—´
                        <input id="coupon_validFrom" type="datetime-local" />
                      </label>
                      <label>
                        ç»“æŸæ—¶é—´
                        <input id="coupon_validTo" type="datetime-local" />
                      </label>
                      <label>
                        ä½¿ç”¨æ¬¡æ•°ä¸Šé™
                        <input
                          id="coupon_limitUse"
                          type="number"
                          placeholder="0 ä¸é™"
                        />
                      </label>
                    </div>
                    <button class="mc-btn-primary" onclick="createCoupon()">
                      ä¿å­˜ä¼˜æƒ åˆ¸
                    </button>
                  </article>
                </section>

                <!-- ========== æ»¡å‡ ========== -->
                <section class="mc-tab-pane" id="mc-tab-promotion">
                  <article style="margin-bottom: 10px">
                    <div class="mc-form-row">
                      <label>
                        æ´»åŠ¨åç§°
                        <input id="promo_name" placeholder="è´­ç‰©æ»¡30å‡5" />
                      </label>
                      <label>
                        ç±»å‹
                        <select id="promo_ruleType">
                          <option value="cart_fullcut">è´­ç‰©è½¦æ»¡å‡</option>
                          <option value="cart_discount">è´­ç‰©è½¦æŠ˜æ‰£</option>
                          <option value="category_discount">åˆ†ç±»æŠ˜æ‰£</option>
                        </select>
                      </label>
                      <label>
                        é—¨æ§›é‡‘é¢
                        <input
                          id="promo_threshold"
                          type="number"
                          step="0.01"
                        />
                      </label>
                      <label>
                        å‡å…/æŠ˜æ‰£
                        <input
                          id="promo_discount"
                          type="number"
                          step="0.01"
                        />
                      </label>
                    </div>
                    <div class="mc-form-row">
                      <label>
                        ç”Ÿæ•ˆæ—¶é—´
                        <input id="promo_validFrom" type="datetime-local" />
                      </label>
                      <label>
                        ç»“æŸæ—¶é—´
                        <input id="promo_validTo" type="datetime-local" />
                      </label>
                      <label style="flex: 1">
                        å¤‡æ³¨
                        <input
                          id="promo_note"
                          placeholder="å¦‚ï¼šå‘¨äº”çˆ†å“æ—¥ä¸“ç”¨"
                        />
                      </label>
                    </div>
                    <button class="mc-btn-primary" onclick="createPromotion()">
                      ä¿å­˜æ´»åŠ¨
                    </button>
                  </article>
                </section>

                <!-- ========== æ‹¼è¿è´¹ ========== -->
                <section class="mc-tab-pane" id="mc-tab-share">
                  <article style="margin-bottom: 10px">
                    <div class="mc-form-row">
                      <label>
                        å•äººè¿è´¹
                        <input id="share_baseFee" type="number" step="0.01" />
                      </label>
                      <label>
                        æ‹¼æˆæœ‰æ•ˆæ—¶é—´(åˆ†é’Ÿ)
                        <input id="share_expire" type="number" />
                      </label>
                    </div>
                    <div class="mc-form-row">
                      <label>
                        2 äººæ‹¼ / æ¯äºº
                        <input id="share_p2" type="number" step="0.01" />
                      </label>
                      <label>
                        3 äººæ‹¼ / æ¯äºº
                        <input id="share_p3" type="number" step="0.01" />
                      </label>
                      <label>
                        4 äººæ‹¼ / æ¯äºº
                        <input id="share_p4" type="number" step="0.01" />
                      </label>
                    </div>
                    <button class="mc-btn-primary" onclick="saveShareShipping()">
                      ä¿å­˜é…ç½®
                    </button>
                  </article>
                </section>

                <!-- ========== ç§’æ€ï¼ˆçˆ†å“æ—¥ï¼‰ ========== -->
                <section class="mc-tab-pane" id="mc-tab-flash">
                  <article style="margin-bottom: 10px">
                    <!-- å•†å“æœç´¢ + é€‰æ‹© -->
                    <div class="mc-form-row">
                      <label class="mc-suggest-wrap" style="flex: 1">
                        é€‰æ‹©å•†å“ï¼ˆè¾“å…¥åç§°æˆ– SKU æœç´¢ï¼‰
                        <input
                          type="text"
                          id="flashProductSearch"
                          placeholder="è¾“å…¥å•†å“åæˆ– SKU å…³é”®å­—"
                          autocomplete="off"
                        />
                        <div
                          id="flashSearchResults"
                          class="mc-suggest-list"
                        ></div>
                      </label>
                    </div>

                    <!-- éšè—çš„ productIdï¼Œæäº¤ç»™åç«¯ç”¨ -->
                    <input type="hidden" id="flash_productId" />

                    <!-- æ˜¾ç¤ºå½“å‰å·²é€‰å•†å“ -->
                    <p
                      id="flashSelectedProductInfo"
                      style="
                        font-size: 12px;
                        color: #9ca3af;
                        margin: 2px 0 6px;
                      "
                    >
                      æœªé€‰æ‹©å•†å“
                    </p>

                    <div class="mc-form-row">
                      <label>
                        ç§’æ€ä»·
                        <input id="flash_price" type="number" step="0.01" />
                      </label>
                      <label>
                        é™è´­æ•°é‡(0ä¸é™)
                        <input id="flash_limit" type="number" />
                      </label>
                    </div>
                    <div class="mc-form-row">
                      <label>
                        å¼€å§‹æ—¶é—´
                        <input id="flash_start" type="datetime-local" />
                      </label>
                      <label>
                        ç»“æŸæ—¶é—´
                        <input id="flash_end" type="datetime-local" />
                      </label>
                      <label>
                        æ ‡ç­¾
                        <input
                          id="flash_tag"
                          placeholder="å‘¨äº”çˆ†å“æ—¥ / ç§’æ€"
                        />
                      </label>
                    </div>
                    <button class="mc-btn-primary" onclick="createFlashSale()">
                      ä¿å­˜ç§’æ€
                    </button>
                  </article>
                </section>

                <!-- ========== ç§¯åˆ† ========== -->
                <section class="mc-tab-pane" id="mc-tab-points">
                  <article style="margin-bottom: 10px">
                    <div class="mc-form-row">
                      <label style="flex: 1">
                        ç”¨æˆ· ID
                        <input
                          id="points_userId"
                          placeholder="User _id æˆ–æµ‹è¯•å­—ç¬¦ä¸²"
                        />
                      </label>
                      <button class="mc-btn-primary" onclick="loadPoints()">
                        æŸ¥è¯¢
                      </button>
                    </div>
                    <p
                      id="points_info"
                      style="font-size: 12px; color: #9ca3af; margin-top: 4px"
                    ></p>
                    <div class="mc-form-row" style="margin-top: 8px">
                      <label>
                        æ•°é‡ï¼ˆæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=æ‰£å‡ï¼‰
                        <input id="points_amount" type="number" />
                      </label>
                      <label style="flex: 1">
                        å¤‡æ³¨
                        <input
                          id="points_remark"
                          placeholder="æ´»åŠ¨èµ é€ / å®¢è¯‰è¡¥å¿ç­‰"
                        />
                      </label>
                    </div>
                    <button class="mc-btn-primary" onclick="adjustPoints()">
                      æäº¤
                    </button>
                  </article>
                </section>
              </div>
            </div>

            <!-- å³ä¾§ï¼šåˆ—è¡¨å±•ç¤ºåŒº -->
            <div>
              <!-- ä¼˜æƒ åˆ¸/æ´»åŠ¨åˆ—è¡¨ -->
              <div class="mc-card">
                <div class="mc-card-header">
                  <div>
                    <div class="mc-card-title">ä¼˜æƒ åˆ¸ & æ´»åŠ¨åˆ—è¡¨</div>
                    <div class="mc-card-sub">
                      è¿™é‡Œæ˜¯å½“å‰æ‰€æœ‰çš„ä¼˜æƒ åˆ¸ã€æ»¡å‡æ´»åŠ¨ã€çˆ†å“æ—¥é…ç½®æ•ˆæœä¸€è§ˆã€‚
                    </div>
                  </div>
                  <button class="mc-btn-outline" onclick="loadAllLists()">
                    åˆ·æ–°
                  </button>
                </div>

                <h3
                  style="
                    font-size: 12px;
                    color: #9ca3af;
                    margin: 4px 0 4px;
                    font-weight: 400;
                  "
                >
                  ä¼˜æƒ åˆ¸åˆ—è¡¨
                </h3>
                <div class="mc-table-wrapper" style="margin-bottom: 8px">
                  <table class="mc-table">
                    <thead>
                      <tr>
                        <th>åç§°</th>
                        <th>ç±»å‹</th>
                        <th>é‡‘é¢</th>
                        <th>é—¨æ§›</th>
                        <th>æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="coupon_tbody"></tbody>
                  </table>
                </div>

                <h3
                  style="
                    font-size: 12px;
                    color: #9ca3af;
                    margin: 6px 0 4px;
                    font-weight: 400;
                  "
                >
                  æ»¡å‡æ´»åŠ¨
                </h3>
                <div class="mc-table-wrapper" style="margin-bottom: 8px">
                  <table class="mc-table">
                    <thead>
                      <tr>
                        <th>åç§°</th>
                        <th>ç±»å‹</th>
                        <th>é—¨æ§›</th>
                        <th>ä¼˜æƒ </th>
                        <th>æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="promo_tbody"></tbody>
                  </table>
                </div>

                <h3
                  style="
                    font-size: 12px;
                    color: #9ca3af;
                    margin: 6px 0 4px;
                    font-weight: 400;
                  "
                >
                  çˆ†å“æ—¥ / ç§’æ€
                </h3>
                <div class="mc-table-wrapper">
                  <table class="mc-table">
                    <thead>
                      <tr>
                        <th>å•†å“</th>
                        <th>ç§’æ€ä»·</th>
                        <th>é™è´­</th>
                        <th>æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="flash_tbody"></tbody>
                  </table>
                </div>
              </div>

              <!-- é‚€è¯·ç»Ÿè®¡ -->
              <div class="mc-card">
                <div class="mc-card-header">
                  <div>
                    <div class="mc-card-title">é‚€è¯·è£‚å˜ç»Ÿè®¡ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰</div>
                    <div class="mc-card-sub">
                      åç»­å¯å¯¹æ¥çœŸå®ç”¨æˆ· & é‚€è¯·è®°å½•è¡¨ï¼›å½“å‰ä¸ºå†…å­˜ç‰ˆå ä½ã€‚
                    </div>
                  </div>
                  <button class="mc-btn-outline" onclick="loadReferrals()">
                    åˆ·æ–°é‚€è¯·æ•°æ®
                  </button>
                </div>
                <div class="mc-table-wrapper">
                  <table class="mc-table">
                    <thead>
                      <tr>
                        <th>ç”¨æˆ· ID</th>
                        <th>é‚€è¯·ç </th>
                        <th>é‚€è¯·äººæ•°</th>
                        <th>å¥–åŠ±è®°å½•</th>
                      </tr>
                    </thead>
                    <tbody id="referral_tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
    <script src="/admin/assets/js/admin_guard.js"></script>
    <script src="./assets/js/admin_auth_ui.js"></script>
    <script>
      const API_BASE = "/api/admin/marketing";

      // Tabs
      document.querySelectorAll(".mc-tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".mc-tab-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tab;
          document
            .querySelectorAll(".mc-tab-pane")
            .forEach((p) => p.classList.remove("active"));
          document.getElementById("mc-tab-" + tab).classList.add("active");
        });
      });

      async function api(path, options = {}) {
        const res = await fetch(API_BASE + path, {
          headers: { "Content-Type": "application/json" },
          ...options,
        });
        return res.json();
      }

      // ---------- ç§’æ€ï¼šå•†å“æœç´¢è”æƒ³ ----------
      const flashProductSearch = document.getElementById("flashProductSearch");
      const flashSearchResults = document.getElementById("flashSearchResults");
      const flashProductIdInput = document.getElementById("flash_productId");
      const flashSelectedProductInfo = document.getElementById(
        "flashSelectedProductInfo"
      );

      let flashSearchTimer = null;

      function renderFlashSearchResults(items) {
        if (!items || !items.length) {
          flashSearchResults.style.display = "none";
          flashSearchResults.innerHTML = "";
          return;
        }

        flashSearchResults.innerHTML = "";

        items.forEach((p) => {
          const row = document.createElement("div");
          row.className = "mc-suggest-item";
          row.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
              ${
                p.image
                  ? `<img src="${p.image}" style="width:32px;height:32px;border-radius:6px;object-fit:cover;" />`
                  : ""
              }
              <div>
                <div style="font-weight:600;">${p.name}</div>
                <div style="font-size:11px;color:#9ca3af;">
                  ID: ${p.id || p._id || "-"} | SKU: ${
            p.sku || "-"
          } | ç°ä»·: $${(p.price || p.originPrice || 0).toFixed(2)}
                </div>
              </div>
            </div>
          `;

          row.addEventListener("click", () => {
            const realId = p.id || p._id || "";
            flashProductIdInput.value = realId;
            flashProductSearch.value = p.name || "";
            flashSearchResults.style.display = "none";
            flashSearchResults.innerHTML = "";

            if (flashSelectedProductInfo) {
              flashSelectedProductInfo.innerHTML = `
                å·²é€‰æ‹©å•†å“ï¼š<strong>${p.name}</strong>
                ï¼ˆID: ${realId}ï¼Œåº“å­˜ï¼š${p.stock ?? 0}ï¼‰
              `;
            }
          });

          flashSearchResults.appendChild(row);
        });

        flashSearchResults.style.display = "block";
      }

      if (flashProductSearch) {
        flashProductSearch.addEventListener("input", () => {
          const kw = flashProductSearch.value.trim();
          flashProductIdInput.value = "";
          if (flashSelectedProductInfo) {
            flashSelectedProductInfo.textContent = "æœªé€‰æ‹©å•†å“";
          }

          if (flashSearchTimer) clearTimeout(flashSearchTimer);

          if (!kw) {
            flashSearchResults.style.display = "none";
            flashSearchResults.innerHTML = "";
            return;
          }

          flashSearchTimer = setTimeout(async () => {
            try {
               const res = await fetch(
  `${API_BASE}/search-product?keyword=${encodeURIComponent(kw)}`
);
              const data = await res.json();
              if (!data.success) {
                console.warn("æœç´¢å•†å“å¤±è´¥:", data.message);
                renderFlashSearchResults([]);
                return;
              }
              renderFlashSearchResults(data.items || []);
            } catch (err) {
              console.error("æœç´¢å•†å“æ¥å£å¼‚å¸¸:", err);
              renderFlashSearchResults([]);
            }
          }, 300);
        });
      }

      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶ï¼Œæ”¶èµ·ä¸‹æ‹‰
      document.addEventListener("click", (e) => {
        if (
          !flashProductSearch?.contains(e.target) &&
          !flashSearchResults?.contains(e.target)
        ) {
          if (flashSearchResults) {
            flashSearchResults.style.display = "none";
          }
        }
      });

      // ---------- ä¼˜æƒ åˆ¸ ----------
      async function loadCoupons() {
        const data = await api("/coupons");
        const tbody = document.getElementById("coupon_tbody");
        tbody.innerHTML = "";
        if (!data.success) return;
        data.list.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.title}</td>
            <td>${c.type}</td>
            <td>${c.amount}</td>
            <td>${c.minSpend}</td>
            <td>
              ${
                c.validFrom
                  ? new Date(c.validFrom).toLocaleDateString()
                  : ""
              } -
              ${
                c.validTo ? new Date(c.validTo).toLocaleDateString() : ""
              }
            </td>
            <td>
              <span class="mc-pill ${
                c.status === "active" ? "mc-pill-green" : "mc-pill-gray"
              }">${c.status}</span>
            </td>
            <td>
              <button class="mc-btn-outline" onclick="toggleCoupon('${
                c._id
              }')">å¯/åœ</button>
              <button class="mc-btn-danger" onclick="deleteCoupon('${
                c._id
              }')">åˆ </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function createCoupon() {
        const body = {
          title: document.getElementById("coupon_title").value,
          type: document.getElementById("coupon_type").value,
          amount: parseFloat(
            document.getElementById("coupon_amount").value || "0"
          ),
          minSpend: parseFloat(
            document.getElementById("coupon_minSpend").value || "0"
          ),
          validFrom: document.getElementById("coupon_validFrom").value,
          validTo: document.getElementById("coupon_validTo").value,
          limitUse: parseInt(
            document.getElementById("coupon_limitUse").value || "0"
          ),
        };
        const data = await api("/coupons", {
          method: "POST",
          body: JSON.stringify(body),
        });
        alert(data.success ? "åˆ›å»ºæˆåŠŸ" : data.message || "å¤±è´¥");
        loadCoupons();
      }

      async function toggleCoupon(id) {
        const data = await api(`/coupons/${id}/toggle`, { method: "PATCH" });
        if (!data.success) alert(data.message || "æ“ä½œå¤±è´¥");
        loadCoupons();
      }

      async function deleteCoupon(id) {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥ä¼˜æƒ åˆ¸ï¼Ÿ")) return;
        await api(`/coupons/${id}`, { method: "DELETE" });
        loadCoupons();
      }

      // ---------- æ»¡å‡ ----------
      async function loadPromotions() {
        const data = await api("/promotions");
        const tbody = document.getElementById("promo_tbody");
        tbody.innerHTML = "";
        if (!data.success) return;
        data.list.forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.ruleType}</td>
            <td>${p.threshold}</td>
            <td>${p.discount}</td>
            <td>
              ${
                p.validFrom
                  ? new Date(p.validFrom).toLocaleDateString()
                  : ""
              } -
              ${
                p.validTo ? new Date(p.validTo).toLocaleDateString() : ""
              }
            </td>
            <td>
              <span class="mc-pill ${
                p.enabled ? "mc-pill-green" : "mc-pill-gray"
              }">
                ${p.enabled ? "å¯ç”¨" : "åœç”¨"}
              </span>
            </td>
            <td>
              <button class="mc-btn-outline" onclick="togglePromotion('${
                p._id
              }')">å¯/åœ</button>
              <button class="mc-btn-danger" onclick="deletePromotion('${
                p._id
              }')">åˆ </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function createPromotion() {
        const body = {
          name: document.getElementById("promo_name").value,
          ruleType: document.getElementById("promo_ruleType").value,
          threshold: parseFloat(
            document.getElementById("promo_threshold").value || "0"
          ),
          discount: parseFloat(
            document.getElementById("promo_discount").value || "0"
          ),
          validFrom: document.getElementById("promo_validFrom").value,
          validTo: document.getElementById("promo_validTo").value,
          note: document.getElementById("promo_note").value,
        };
        const data = await api("/promotions", {
          method: "POST",
          body: JSON.stringify(body),
        });
        alert(data.success ? "åˆ›å»ºæˆåŠŸ" : data.message || "å¤±è´¥");
        loadPromotions();
      }

      async function togglePromotion(id) {
        const data = await api(`/promotions/${id}/toggle`, { method: "PATCH" });
        if (!data.success) alert(data.message || "æ“ä½œå¤±è´¥");
        loadPromotions();
      }

      async function deletePromotion(id) {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥æ´»åŠ¨ï¼Ÿ")) return;
        await api(`/promotions/${id}`, { method: "DELETE" });
        loadPromotions();
      }

      // ---------- æ‹¼è¿è´¹ ----------
      async function loadShareShipping() {
        const data = await api("/share-shipping");
        if (!data.success) return;
        const cfg = data.data;
        document.getElementById("share_baseFee").value = cfg.baseFee ?? 4.99;
        document.getElementById("share_expire").value =
          cfg.expireMinutes ?? 15;
        const s2 = cfg.steps?.find((s) => s.people === 2);
        const s3 = cfg.steps?.find((s) => s.people === 3);
        const s4 = cfg.steps?.find((s) => s.people === 4);
        document.getElementById("share_p2").value = s2?.price ?? 1.99;
        document.getElementById("share_p3").value = s3?.price ?? 0.99;
        document.getElementById("share_p4").value = s4?.price ?? 0;
      }

      async function saveShareShipping() {
        const body = {
          baseFee: parseFloat(
            document.getElementById("share_baseFee").value || "4.99"
          ),
          expireMinutes: parseInt(
            document.getElementById("share_expire").value || "15"
          ),
          steps: [
            {
              people: 2,
              price: parseFloat(
                document.getElementById("share_p2").value || "1.99"
              ),
            },
            {
              people: 3,
              price: parseFloat(
                document.getElementById("share_p3").value || "0.99"
              ),
            },
            {
              people: 4,
              price: parseFloat(
                document.getElementById("share_p4").value || "0"
              ),
            },
          ],
        };
        const data = await api("/share-shipping", {
          method: "POST",
          body: JSON.stringify(body),
        });
        alert(data.success ? "ä¿å­˜æˆåŠŸ" : data.message || "å¤±è´¥");
      }

      // ---------- ç§’æ€ ----------
      async function loadFlashSales() {
        const data = await api("/flash-sales");
        const tbody = document.getElementById("flash_tbody");
        tbody.innerHTML = "";
        if (!data.success) return;
        data.list.forEach((f) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${f.productName || f.productId || ""}</td>
            <td>${f.flashPrice}</td>
            <td>${f.limitQty}</td>
            <td>
              ${f.start ? new Date(f.start).toLocaleString() : ""}<br/>
              ${f.end ? new Date(f.end).toLocaleString() : ""}
            </td>
            <td>
              <span class="mc-pill ${
                f.enabled ? "mc-pill-green" : "mc-pill-gray"
              }">
                ${f.enabled ? "å¯ç”¨" : "åœç”¨"}
              </span>
            </td>
            <td>
              <button class="mc-btn-outline" onclick="toggleFlashSale('${
                f._id
              }')">å¯/åœ</button>
              <button class="mc-btn-danger" onclick="deleteFlashSale('${
                f._id
              }')">åˆ </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function createFlashSale() {
        const productId = (flashProductIdInput?.value || "").trim();
        if (!productId) {
          alert("è¯·å…ˆé€šè¿‡ä¸Šæ–¹æœç´¢é€‰æ‹©ä¸€ä¸ªå•†å“");
          return;
        }

        const body = {
          productId,
          flashPrice: parseFloat(
            document.getElementById("flash_price").value || "0"
          ),
          limitQty: parseInt(
            document.getElementById("flash_limit").value || "0"
          ),
          start: document.getElementById("flash_start").value,
          end: document.getElementById("flash_end").value,
          tag: document.getElementById("flash_tag").value || "çˆ†å“æ—¥",
        };
        const data = await api("/flash-sales", {
          method: "POST",
          body: JSON.stringify(body),
        });
        alert(data.success ? "åˆ›å»ºæˆåŠŸ" : data.message || "å¤±è´¥");
        loadFlashSales();
      }

      async function toggleFlashSale(id) {
        const data = await api(`/flash-sales/${id}/toggle`, {
          method: "PATCH",
        });
        if (!data.success) alert(data.message || "æ“ä½œå¤±è´¥");
        loadFlashSales();
      }

      async function deleteFlashSale(id) {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥ç§’æ€ï¼Ÿ")) return;
        await api(`/flash-sales/${id}`, { method: "DELETE" });
        loadFlashSales();
      }

      // ---------- é‚€è¯· ----------
      async function loadReferrals() {
        const data = await api("/referrals");
        const tbody = document.getElementById("referral_tbody");
        tbody.innerHTML = "";
        if (!data.success) return;
        data.list.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.userId || ""}</td>
            <td>${r.inviteCode}</td>
            <td>${r.invitedUsers?.length || 0}</td>
            <td>${r.rewards?.length || 0} æ¡</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // ---------- ç§¯åˆ† ----------
      let currentPointsUserId = "";

      async function loadPoints() {
        const userId = document.getElementById("points_userId").value.trim();
        if (!userId) {
          alert("è¯·è¾“å…¥ç”¨æˆ·ID");
          return;
        }
        currentPointsUserId = userId;
        const data = await api(`/points/${userId}`);
        const info = document.getElementById("points_info");
        if (!data.success) {
          info.textContent = "æŸ¥è¯¢å¤±è´¥";
          return;
        }
        if (!data.data) {
          info.textContent = "æš‚æ— ç§¯åˆ†è®°å½•ï¼Œå½“å‰ç§¯åˆ†ï¼š0";
        } else {
          info.textContent = `å½“å‰ç§¯åˆ†ï¼š${data.data.points}`;
        }
      }

      async function adjustPoints() {
        const userId =
          currentPointsUserId ||
          document.getElementById("points_userId").value.trim();
        if (!userId) {
          alert("è¯·å…ˆæŸ¥è¯¢ç”¨æˆ·ID");
          return;
        }
        const amount = parseInt(
          document.getElementById("points_amount").value || "0"
        );
        const remark = document.getElementById("points_remark").value;
        if (!amount) {
          alert("è¯·è¾“å…¥é0çš„æ•°é‡");
          return;
        }
        const path =
          amount > 0 ? `/points/${userId}/earn` : `/points/${userId}/use`;
        const data = await api(path, {
          method: "POST",
          body: JSON.stringify({ amount: Math.abs(amount), remark }),
        });
        alert(data.success ? "æ“ä½œæˆåŠŸ" : data.message || "å¤±è´¥");
        loadPoints();
      }

      // ä¸€é”®åˆ·æ–°æ‰€æœ‰åˆ—è¡¨
      function loadAllLists() {
        loadCoupons();
        loadPromotions();
        loadFlashSales();
      }

      // åˆå§‹åŒ–
      (function init() {
        loadCoupons();
        loadPromotions();
        loadShareShipping();
        loadFlashSales();
        loadReferrals();
      })();
    </script>
 <!-- âœ… ç»Ÿä¸€ sidebar æ³¨å…¥è„šæœ¬ï¼ˆå¿…é¡»åŠ ï¼‰ -->
    <script src="/admin/assets/js/admin_sidebar.js"></script>
    <!-- ä¿ç•™åŸæœ‰ admin.jsï¼ˆè´Ÿè´£ä¾§è¾¹æ é«˜äº®ç­‰ï¼‰ -->
    <script src="assets/js/admin.js"></script>
  </body>
</html>
