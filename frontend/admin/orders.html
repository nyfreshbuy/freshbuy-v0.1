<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>è®¢å•ç®¡ç† - åœ¨é²œè´­æ‹¼å¥½è´§åå°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/css/admin.css" />
    <style>
      /* è®¢å•è¯¦æƒ…ä¾§æ çš„å°æ ·å¼å¢å¼º */
      .order-detail-panel {
        margin-top: 12px;
        display: none;
        grid-template-columns: 2fr 1fr;
        gap: 10px;
      }
      .order-detail-panel.active {
        display: grid;
      }
      .order-detail-card {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 14px;
        padding: 10px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: #e5e7eb;
        font-size: 13px;
      }
      .order-detail-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .order-detail-row {
        margin-bottom: 4px;
      }
      .order-detail-label {
        color: #9ca3af;
        margin-right: 4px;
      }
      .delivery-pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(56, 189, 248, 0.12);
        color: #38bdf8;
      }
      .delivery-pill.pickup {
        background: rgba(16, 185, 129, 0.12);
        color: #34d399;
      }
      .pay-pill {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(248, 250, 252, 0.08);
        color: #e5e7eb;
      }
      .stat-highlight {
        font-weight: 600;
        color: #a5b4fc;
      }

      /* åˆ—è¡¨é‡Œçš„å°åœ†å½¢é…é€åºå·æ ‡è®° */
      .order-seq-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.16);
        color: #38bdf8;
        font-weight: 700;
        font-size: 18px;
      }
      .order-seq-badge.order-seq-empty {
        opacity: 0.35;
      }

      /* è®¢å•è¯¦æƒ…é‡Œçš„å¤§å·é…é€åºå·ï¼ˆå¸æœºä¸“ç”¨å¤§å­—ç‰ˆï¼‰ */
      .order-detail-seq-box {
        margin-bottom: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(34, 197, 94, 0.18);
        border: 1px solid #22c55e;
        text-align: center;
      }
      .order-detail-seq-label {
        font-size: 12px;
        color: #bbf7d0;
        letter-spacing: 1px;
      }
      .order-detail-seq-value {
        font-size: 32px;
        font-weight: 900;
        color: #4ade80;
        line-height: 1.1;
      }
    </style>
  </head>

  <body data-page="orders">
    <div class="admin-layout">
      <!-- å·¦ä¾§ä¾§è¾¹æ ï¼ˆç®€ç‰ˆï¼‰ -->
      <aside class="admin-sidebar">
      <!-- âœ… ç»Ÿä¸€ sidebarï¼šç”± /admin/assets/js/admin_sidebar.js æ³¨å…¥ -->
      <div id="adminSidebar"></div>
    </aside>
      <!-- å³ä¾§ä¸»åŒºåŸŸ -->
      <div class="admin-main">
        <!-- é¡¶éƒ¨æ  -->
        <header class="admin-topbar">
          <button class="admin-btn admin-btn-ghost admin-topbar-toggle" data-toggle-sidebar>
            â˜°
          </button>
          <div class="admin-topbar-title">è®¢å•ç®¡ç†</div>
          <div class="admin-topbar-spacer"></div>

          <div class="admin-search">
            <span class="admin-search-icon">ğŸ”</span>
            <input type="text" id="searchKeyword" placeholder="è®¢å•å· / ç”¨æˆ·å / æ‰‹æœºå·" />
          </div>

          <div class="admin-user">
            <div class="admin-user-avatar">A</div>
            <div class="admin-user-info">
              <span class="admin-user-name">Admin</span>
              <span class="admin-user-role">è¶…çº§ç®¡ç†å‘˜</span>
            </div>
          </div>
        </header>

        <!-- å†…å®¹ -->
        <main class="admin-content">
          <!-- æ ‡é¢˜ + æ“ä½œ -->
          <div class="admin-page-header">
            <div>
              <div class="admin-page-title">è®¢å•åˆ—è¡¨</div>
              <div class="admin-breadcrumb">åå° &gt; è®¢å•ç®¡ç†</div>
            </div>

            <div class="admin-page-actions">
              <button class="admin-btn admin-btn-ghost" id="btnRefresh">âŸ³ åˆ·æ–°</button>
              <button class="admin-btn admin-btn-secondary" id="btnGoPicklist">ğŸ“¦ æœ¬å‘¨é…è´§å•</button>
              <button class="btn primary" id="btnPackBatch">æ‰“åŒ…æˆé…è´§å•</button>
              <button class="admin-btn admin-btn-secondary" id="btnOptimizeRoute">ğŸ“ è·¯çº¿æ™ºèƒ½æ’åº</button>
              <button class="admin-btn admin-btn-primary">â¬‡ å¯¼å‡ºè®¢å•ï¼ˆå ä½ï¼‰</button>
            </div>
          </div>

          <!-- ç­›é€‰æ¡ -->
          <section class="admin-card admin-card-ghost">
            <div class="admin-card-title">
              ç­›é€‰æ¡ä»¶
              <span id="filterSummary" style="font-size: 11px; color: #9ca3af; margin-left: 8px"></span>
            </div>
            <div
              style="
                margin-top: 8px;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                align-items: center;
              "
            >
              <!-- è®¢å•çŠ¶æ€ -->
              <select id="filterStatus" class="admin-input">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="pending">å¾…æ”¯ä»˜ / å¾…ç¡®è®¤</option>
                <option value="paid">å·²æ”¯ä»˜</option>
                <option value="packing">é…è´§ä¸­</option>
                <option value="shipping">é…é€ä¸­</option>
                <option value="done">å·²å®Œæˆ</option>
                <option value="cancelled">å·²å–æ¶ˆ</option>
              </select>

              <!-- æ”¶è´§æ–¹å¼ï¼šé€è´§ä¸Šé—¨ / å›¢é•¿è‡ªæ -->
              <select id="filterDelivery" class="admin-input">
                <option value="">å…¨éƒ¨æ”¶è´§æ–¹å¼</option>
                <option value="door">é€è´§ä¸Šé—¨</option>
                <option value="pickup">å›¢é•¿è‡ªæ</option>
              </select>

              <!-- é…é€æ¨¡å¼ï¼ˆä¸šåŠ¡æ¨¡å¼ï¼‰ -->
              <select id="filterServiceMode" class="admin-input">
                <option value="">å…¨éƒ¨é…é€æ¨¡å¼</option>
                <option value="normal">æ¬¡æ—¥é…é€</option>
                <option value="friend">å¥½å‹æ‹¼å•é…é€</option>
                <option value="areaGroup">åŒºåŸŸå›¢æ‹¼å•é…é€</option>
              </select>

              <!-- åŒºåŸŸå›¢æ‹¼å•çš„åŒºåŸŸç­›é€‰ -->
              <select id="filterAreaGroupZone" class="admin-input" style="display: none; min-width: 180px">
                <option value="">å…¨éƒ¨åŒºåŸŸ</option>
              </select>

              <!-- æ—¶é—´èŒƒå›´ -->
              <div style="display: flex; gap: 4px; align-items: center">
                <input id="filterFrom" type="date" class="admin-input" style="width: 150px" />
                <span style="font-size: 12px; color: #9ca3af">è‡³</span>
                <input id="filterTo" type="date" class="admin-input" style="width: 150px" />
              </div>

              <button class="admin-btn admin-btn-primary" id="btnSearch">æŸ¥è¯¢</button>

              <button class="admin-btn admin-btn-ghost" id="btnPrintOrderList">æ‰“å°ç­›é€‰è®¢å•</button>
            </div>
          </section>

          <!-- è®¢å•è¡¨æ ¼ -->
          <section class="admin-table-card" style="margin-top: 12px">
            <div class="admin-card-header">
              <div>
                <div class="admin-card-header-title">è®¢å•åˆ—è¡¨</div>
                <div class="admin-card-header-sub">
                  ä» <code>/api/admin/orders</code> æ‹‰å–æ•°æ®ï¼Œæ”¯æŒç­›é€‰å’Œåˆ†é¡µï¼Œå¯æŸ¥çœ‹è®¢å•è¯¦æƒ…ã€æ‰“å°é…è´§å°ç¥¨ï¼Œå¹¶å¯æ ¹æ®
                  Google è·¯çº¿è‡ªåŠ¨ä¼˜åŒ–é…é€é¡ºåºã€‚
                </div>
              </div>
              <div id="gmvSummary" style="font-size: 12px; color: #e5e7eb">
                å½“å‰ç­›é€‰ GMVï¼š<span class="stat-highlight">$0.00</span>
              </div>
            </div>

            <div class="admin-table-wrapper">
              <table class="admin-table" id="ordersTable">
                <thead>
  <tr>
    <th style="width: 46px">
      <input type="checkbox" id="checkAllOrders" />
    </th>
    <th style="width: 70px">åºå·</th>
    <th>è®¢å•å·</th>
                    <th>ç”¨æˆ·</th>
                    <th>é‡‘é¢</th>
                    <th>é…é€æ–¹å¼</th>
                    <th>å›¢é•¿/è‡ªæç‚¹</th>
                    <th>å•†å“æ•°</th>
                    <th>è®¢å•çŠ¶æ€</th>
                    <th>ä¸‹å•æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="ordersTableBody">
                  <tr>
                    <td colspan="11">æ­£åœ¨åŠ è½½è®¢å•...</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="admin-pagination" id="ordersPagination">
              <span id="ordersSummary">å…± 0 ç¬”è®¢å•</span>
              <div>
                <button class="admin-btn admin-btn-ghost" id="btnPrevPage" disabled>Â«</button>
                <span id="pageInfo" style="margin: 0 6px; font-size: 12px">ç¬¬ 1 / 1 é¡µ</span>
                <button class="admin-btn admin-btn-ghost" id="btnNextPage" disabled>Â»</button>
              </div>
            </div>
          </section>

          <!-- è®¢å•è¯¦æƒ…é¢æ¿ -->
          <section id="orderDetailPanel" class="order-detail-panel">
            <div class="order-detail-card">
              <div class="order-detail-title">è®¢å•è¯¦æƒ…</div>

              <div id="orderDetailSeqBox" class="order-detail-seq-box" style="display: none">
                <div class="order-detail-seq-label">é…é€åºå·</div>
                <div id="orderDetailSeqValue" class="order-detail-seq-value">--</div>
              </div>

              <div id="orderDetailMain">
                <div style="font-size: 12px; color: #9ca3af">ç‚¹å‡»åˆ—è¡¨ä¸­çš„ã€Œè¯¦æƒ…ã€æŒ‰é’®æŸ¥çœ‹å…·ä½“è®¢å•ã€‚</div>
              </div>
            </div>
            <div class="order-detail-card">
              <div class="order-detail-title">å•†å“æ˜ç»†</div>
              <div id="orderItemList">
                <div style="font-size: 12px; color: #9ca3af">å•†å“åˆ—è¡¨ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
     <script src="/admin/assets/js/admin_fetch.js"></script>
    <script src="/admin/assets/js/admin_guard.js"></script>
    <script src="./assets/js/admin_auth_ui.js"></script>
    <!-- å…ˆåŠ è½½ Google Maps JS -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6GEAhetFXnP-y9iYaE7oewv-mLKrELN0&loading=async"></script>

    <script src="assets/js/admin.js"></script>
    <script>
      let currentPage = 1;
      const pageSize = 20;
      let totalPages = 1;
      let currentOrdersCache = [];

      // Google DirectionsServiceï¼ˆåªç”¨æ¥ç®—è·¯çº¿ï¼Œä¸ç”»åœ°å›¾ï¼‰
      let directionsService = null;

      function formatDate(str) {
        if (!str) return "-";
        const d = new Date(str);
        if (Number.isNaN(d.getTime())) return str;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      }

      function renderStatusTag(status) {
        const s = (status || "").toLowerCase();
        if (s === "done" || s === "completed")
          return '<span class="admin-tag admin-tag-success">å·²å®Œæˆ</span>';
        if (s === "shipping")
          return '<span class="admin-tag admin-tag-warning">é…é€ä¸­</span>';
        if (s === "packing")
          return '<span class="admin-tag admin-tag-warning">é…è´§ä¸­</span>';
        if (s === "paid")
          return '<span class="admin-tag admin-tag-success">å·²æ”¯ä»˜</span>';
        if (s === "cancelled") return '<span class="admin-tag">å·²å–æ¶ˆ</span>';
        return '<span class="admin-tag">å¾…æ”¯ä»˜</span>';
      }

      // âœ… ä»è®¢å•å¯¹è±¡æ¨æ–­æ”¶è´§æ–¹å¼ï¼šdoor / pickup
      function getDeliveryType(o) {
        const v = String(
          o.deliveryType ||
            o.fulfillmentType ||
            o.shippingType ||
            o.receiveMode ||
            ""
        ).toLowerCase();

        if (v === "door" || v === "delivery" || v === "home") return "door";
        if (v === "pickup" || v === "leader") return "pickup";

        // å…œåº•ï¼šæœ‰åœ°å€å­—æ®µå°±å½“é€è´§ä¸Šé—¨
        if (o.address || o.shippingAddress || o.fullAddress) return "door";
        return "";
      }

      // âœ… ä»è®¢å•å¯¹è±¡æ¨æ–­ä¸šåŠ¡æ¨¡å¼ï¼šnormal / groupDay / dealsDay / friendGroup
      function getServiceMode(o) {
        const raw = String(
          o.deliveryMode ||
            o.serviceMode ||
            o.bizMode ||
            o.orderMode ||
            o.orderType ||
            ""
        ).trim();

        // å…¼å®¹è€å­—æ®µ
        if (raw === "area_group") return "groupDay";
        if (raw === "friend_group") return "friendGroup";
        if (raw === "areaGroup") return "groupDay";
        if (raw === "friend") return "friendGroup";

        const allow = new Set(["normal", "groupDay", "dealsDay", "friendGroup"]);
        return allow.has(raw) ? raw : raw;
      }

      function renderDeliveryLabel(type) {
        const t = (type || "").toLowerCase();
        if (t === "door") return '<span class="delivery-pill">é€è´§ä¸Šé—¨</span>';
        if (t === "pickup")
          return '<span class="delivery-pill pickup">å›¢é•¿è‡ªæ</span>';
        return "æœªçŸ¥";
      }

      // âœ… ä¸šåŠ¡æ¨¡å¼ label
      function renderServiceModeLabel(mode) {
        const m = String(mode || "").trim();
        const map = {
          normal: "æ¬¡æ—¥é…é€",
          groupDay: "åŒºåŸŸå›¢",
          dealsDay: "çˆ†å“æ—¥",
          friendGroup: "å¥½å‹æ‹¼å•",
        };
        return map[m] || "æœªçŸ¥";
      }

      function formatPayMethod(pm) {
        const v = (pm || "").toLowerCase();
        if (!v) return "â€”";
        if (v === "card") return "ä¿¡ç”¨å¡";
        if (v === "cash") return "ç°é‡‘";
        if (v === "applepay") return "Apple Pay";
        if (v === "wechat") return "å¾®ä¿¡æ”¯ä»˜";
        if (v === "alipay") return "æ”¯ä»˜å®";
        return pm;
      }

      // é€šç”¨è·å–é…é€åºå·ï¼ˆä¼˜å…ˆ routeSeqï¼Œå…¶æ¬¡ sequenceNumber / sequenceNoï¼‰
      function getOrderSeq(o) {
        if (typeof o.routeSeq === "number") return o.routeSeq;
        if (typeof o.sequenceNumber === "number") return o.sequenceNumber;
        if (typeof o.sequenceNo === "number") return o.sequenceNo;
        return null;
      }

      // å°ç¥¨ä¸“ç”¨ï¼šå§“åè„±æ•ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªå­—/å§“
      function maskName(name) {
        if (!name) return "â€”";
        const n = String(name).trim();
        if (n.includes(" ")) {
          const parts = n.split(/\s+/);
          return parts[0] + " *";
        }
        if (n.length <= 1) return n;
        return n[0] + "*".repeat(n.length - 1);
      }

      // å°ç¥¨ä¸“ç”¨ï¼šæ‰‹æœºå·è„±æ•ï¼Œä¿ç•™å‰2+å2
      function maskPhone(phone) {
        if (!phone) return "â€”";
        const p = String(phone).trim();
        if (p.length <= 4) return p;
        return p.slice(0, 2) + "*".repeat(p.length - 4) + p.slice(-2);
      }

      // å½“å‰è®¢å•åˆ—è¡¨çš„ GMV
      function computeGMV(list) {
        return list.reduce((sum, o) => {
          const amount =
            typeof o.totalAmount === "number" ? o.totalAmount : o.amount || 0;
          return sum + Number(amount || 0);
        }, 0);
      }
      function bindCheckAll() {
  const all = document.getElementById("checkAllOrders");
  if (!all) return;

  all.addEventListener("change", () => {
    const checked = all.checked;
    document.querySelectorAll(".order-check").forEach((c) => {
      c.checked = checked;
    });
  });
}
      // âœ… ä»è®¢å•é‡Œæå– zoneIdï¼ˆå…¼å®¹å¤šç§ç»“æ„ï¼‰
      function getZoneIdFromOrder(o) {
        const z =
          (o && o.address && o.address.zoneId) ||
          (o && o.fulfillment && o.fulfillment.zoneId) ||
          o.zoneId ||
          o.areaGroupZone ||
          "";
        return String(z || "").trim();
      }
      // âœ… zoneId â†’ åŒºåŸŸåç§°ï¼ˆä¼˜å…ˆç”¨è®¢å•é‡Œå¸¦çš„ zoneNameï¼‰
function getZoneNameFromOrder(o) {
  return (
    (o && o.address && o.address.zoneName) ||
    (o && o.fulfillment && o.fulfillment.zoneName) ||
    o.zoneName ||
    o.areaGroupZoneName ||
    ""
  );
}

// ID å¤ªé•¿æ—¶ç¼©çŸ­æ˜¾ç¤º
function shortId(id) {
  const s = String(id || "");
  if (s.length <= 10) return s;
  return s.slice(0, 6) + "â€¦" + s.slice(-4);
}

// âœ… zoneId -> zoneNameï¼ˆä» /api/admin/zones æ‹‰å–ï¼‰
let ZONE_NAME_MAP = {}; // { [zoneId]: zoneName }

// âœ… æ‹‰å–åŒºåŸŸåˆ—è¡¨ï¼Œå¡«å…… ZONE_NAME_MAP
async function loadZoneNameMap() {
  try {
    const res = await adminFetch("/api/admin/zones");
    const data = await res.json();

    const zones = Array.isArray(data) ? data : (data?.zones || []);
    const map = {};

    (zones || []).forEach((z) => {
      const id = String(z._id || z.id || z.zoneId || "").trim();
      const name = String(z.name || z.zoneName || z.title || "").trim();
      if (id && name) map[id] = name;
    });

    ZONE_NAME_MAP = map;
    console.log("âœ… ZONE_NAME_MAP loaded:", ZONE_NAME_MAP);
  } catch (e) {
    console.warn("âš ï¸ loadZoneNameMap failed, will fallback to order.zoneName:", e);
    ZONE_NAME_MAP = {};
  }
}
      // âœ… åŠ¨æ€åˆ·æ–°åŒºåŸŸä¸‹æ‹‰ï¼ˆåŸºäºå½“å‰é¡µè®¢å•çœŸå® zoneIdï¼‰
      function refreshAreaGroupZoneSelect(selectEl, orders, keepSelectedValue) {
  if (!selectEl) return;

  const prev = keepSelectedValue ? String(selectEl.value || "") : "";
  selectEl.innerHTML = `<option value="">å…¨éƒ¨åŒºåŸŸ</option>`;

  // zoneId -> { count, name }
  const zones = new Map();

  (orders || []).forEach((o) => {
    const zoneId = getZoneIdFromOrder(o);
    if (!zoneId) return;

    const nameFromOrder = getZoneNameFromOrder(o);
    const displayName = nameFromOrder || ZONE_NAME_MAP[String(zoneId).trim()] || "";
    const cur = zones.get(zoneId) || { count: 0, name: "" };
    cur.count += 1;
    if (!cur.name && displayName) cur.name = displayName;

    zones.set(zoneId, cur);
  });

  Array.from(zones.entries())
    .sort((a, b) => b[1].count - a[1].count)
    .forEach(([zoneId, info]) => {
      const opt = document.createElement("option");
      opt.value = zoneId;

      const label = info.name || shortId(zoneId);
      opt.textContent = `${label} (${info.count})`;
      opt.title = zoneId; // æ‚¬åœå¯çœ‹å®Œæ•´ ID

      selectEl.appendChild(opt);
    });

  if (prev && Array.from(selectEl.options).some((x) => x.value === prev)) {
    selectEl.value = prev;
  }
}
      // æ„é€ åœ°å€å­—ç¬¦ä¸²ï¼ˆç»™ Google ç”¨ï¼‰
      function buildOrderAddress(o) {
        return o.fullAddress || o.address || o.shippingAddress || "";
      }

      // âœ… ä¸€é”®æ‰“å°å½“å‰é¡µç¼“å­˜ï¼ˆæ‰¹é‡ï¼‰â€”â€”ä½¿ç”¨ routeSeq é¡ºåº
      function printOrderList() {
        if (!currentOrdersCache.length) {
          alert("å½“å‰é¡µæ²¡æœ‰å¯æ‰“å°çš„è®¢å•");
          return;
        }

        const orders = [...currentOrdersCache].sort((a, b) => {
          const sa = getOrderSeq(a);
          const sb = getOrderSeq(b);
          if (sa != null && sb != null) return sa - sb;
          if (sa != null) return -1;
          if (sb != null) return 1;
          const ta = new Date(a.createdAt || 0).getTime();
          const tb = new Date(b.createdAt || 0).getTime();
          return ta - tb;
        });

        const ticketsHtml = orders
          .map((o) => {
            const orderId = o.orderNo || o._id || o.id || "";
            const amount =
              typeof o.totalAmount === "number" ? o.totalAmount : o.amount || 0;

            const rawUserName = (o.user && o.user.name) || o.customerName || "â€”";
            const rawUserPhone =
              (o.user && o.user.phone) || o.customerPhone || "";

            const userName = maskName(rawUserName);
            const userPhone = maskPhone(rawUserPhone);

            const address = o.address || o.shippingAddress || "â€”";
            const items = o.items || [];
            const deliveryFee = Number(o.deliveryFee || o.shippingFee || 0);
            const createdAt = o.createdAt;
            const payMethod = formatPayMethod(o.payMethod);
            const seq = getOrderSeq(o);

            const serviceText = renderServiceModeLabel(getServiceMode(o));
            const receiveText =
              getDeliveryType(o) === "pickup" ? "å›¢é•¿è‡ªæ" : "é€è´§ä¸Šé—¨";
            const deliveryModeText = `${serviceText} / ${receiveText}`;

            const itemsRows =
              items
                .map((it) => {
                  const name = it.name || it.productName || "å•†å“";
                  const qty = it.qty || it.quantity || 1;
                  const price = Number(it.price || it.unitPrice || 0);
                  const subtotal = price * qty;
                  return `
                    <tr>
                      <td>${name}</td>
                      <td>${qty}</td>
                      <td>$${price.toFixed(2)}</td>
                      <td>$${subtotal.toFixed(2)}</td>
                    </tr>
                  `;
                })
                .join("") || "";

            return `
              <div class="ticket">
                <h1>åœ¨é²œè´­æ‹¼å¥½è´§ Â· é…è´§å°ç¥¨</h1>

                <div class="seq-box">
                  <div class="seq-label">é…é€åºå·</div>
                  <div class="seq-value">${seq != null ? seq : "-"}</div>
                </div>

                <div class="meta">
                  <div>è®¢å•å·ï¼š${orderId}</div>
                  <div>ä¸‹å•æ—¶é—´ï¼š${formatDate(createdAt)}</div>
                  <div>å®¢æˆ·å§“åï¼š${userName}</div>
                  <div>è”ç³»ç”µè¯ï¼š${userPhone}</div>
                  <div>é…é€æ–¹å¼ï¼š${deliveryModeText}</div>
                  <div>æ”¶è´§åœ°å€ï¼š${address}</div>
                  <div>æ”¯ä»˜æ–¹å¼ï¼š${payMethod}</div>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th>å•†å“</th>
                      <th>æ•°é‡</th>
                      <th>å•ä»·</th>
                      <th>å°è®¡</th>
                    </tr>
                  </thead>
                  <tbody>${itemsRows}</tbody>
                </table>

                <div class="total">
                  å•†å“æ€»é¢ï¼š$${Number(amount).toFixed(2)}<br/>
                  é…é€è´¹ï¼š$${deliveryFee.toFixed(2)}<br/>
                  <strong>åº”ä»˜æ€»é¢ï¼š$${(Number(amount) + deliveryFee).toFixed(2)}</strong>
                </div>
              </div>
            `;
          })
          .join("");

        const html = `
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>é…è´§å°ç¥¨æ‰¹é‡æ‰“å°</title>
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
                  padding: 16px;
                  color: #111827;
                }
                h1 { font-size: 18px; margin-bottom: 8px; }
                .seq-box {
                  margin-bottom: 8px;
                  padding: 6px 8px;
                  border-radius: 8px;
                  border: 1px solid #16a34a;
                  background: #dcfce7;
                  text-align: center;
                }
                .seq-label { font-size: 11px; color: #166534; letter-spacing: 1px; }
                .seq-value { font-size: 26px; font-weight: 900; color: #166534; line-height: 1.1; }
                .meta { font-size: 12px; margin-bottom: 10px; }
                .meta div { margin-bottom: 2px; }
                table {
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 12px;
                  margin-top: 6px;
                }
                th, td { border: 1px solid #e5e7eb; padding: 4px 6px; }
                th { background: #f9fafb; }
                .total { margin-top: 10px; font-size: 13px; text-align: right; }
                .total strong { font-size: 14px; }
                .ticket { page-break-after: always; margin-bottom: 24px; }
              </style>
            </head>
            <body>${ticketsHtml}</body>
          </html>
        `;

        const win = window.open("", "_blank");
        if (!win) {
          alert("æµè§ˆå™¨æ‹¦æˆªäº†æ‰“å°çª—å£ï¼Œè¯·å…è®¸å¼¹çª—åé‡è¯•ã€‚");
          return;
        }
        win.document.write(html);
        win.document.close();
        win.focus();
        win.print();
        win.close();
      }
      async function packSelectedOrders() {
  // åªæ‰“åŒ…å½“å‰é¡µå‹¾é€‰çš„
  const ids = Array.from(document.querySelectorAll(".order-check:checked"))
    .map((el) => el.getAttribute("data-id"))
    .filter(Boolean);

  if (!ids.length) {
    alert("è¯·å…ˆå‹¾é€‰è¦æ‰“åŒ…çš„è®¢å•ï¼ˆå½“å‰é¡µï¼‰");
    return;
  }

  if (!confirm(`ç¡®è®¤æ‰“åŒ… ${ids.length} ä¸ªè®¢å•ï¼Ÿæ‰“åŒ…åçŠ¶æ€ä¼šå˜æˆã€é…è´§ä¸­ã€‘`)) return;

  try {
    const res = await adminFetch("/api/admin/orders/batch-pack", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ orderIds: ids }),
});
    const data = await res.json();
    if (!data.success) {
      alert("æ‰“åŒ…å¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
      return;
    }

    // âœ… è·³è½¬åˆ°é…è´§é¡µï¼ˆä½ ä¹‹ååœ¨è¿™ä¸ªé¡µé¢æ‰“å°20è´´ã€åˆ†é…å¸æœºï¼‰
    window.location.href = `/admin/packing.html?batch=${encodeURIComponent(data.batchId)}`;
  } catch (e) {
    console.error(e);
    alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ /api/admin/orders/batch-pack æ˜¯å¦å¯ç”¨");
  }
}
      // âœ… æ¸²æŸ“å½“å‰é¡µç¼“å­˜åˆ°è¡¨æ ¼ï¼ˆå«é…é€åºå·ï¼‰
      function renderTableFromCache(total, totalPagesValue) {
        const tbody = document.getElementById("ordersTableBody");
        if (!tbody) return;

        if (!currentOrdersCache.length) {
          tbody.innerHTML = '<tr><td colspan="11">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®¢å•</td></tr>';
        } else {
          tbody.innerHTML = "";
          currentOrdersCache.forEach((o) => {
            const tr = document.createElement("tr");
            const oid = o.orderNo || o._id || o.id || "";
            const userName = (o.user && o.user.name) || o.customerName || "â€”";
            const userPhone = (o.user && o.user.phone) || o.customerPhone || "";
            const leaderName = (o.leader && o.leader.name) || o.leaderName || "";
            const pickupName = o.pickupName || "";

            const amount =
              typeof o.totalAmount === "number" ? o.totalAmount : o.amount || 0;
            const itemCount = o.items ? o.items.length : o.itemCount || 0;
            const seq = getOrderSeq(o);

            const serviceText = renderServiceModeLabel(getServiceMode(o));
            const receiveText = renderDeliveryLabel(getDeliveryType(o));

            tr.innerHTML = `
  <td>
    <input type="checkbox" class="order-check" data-id="${o._id || o.id || oid}" />
  </td>
  <td>${
    seq != null
      ? `<span class="order-seq-badge">${seq}</span>`
      : '<span class="order-seq-badge order-seq-empty">-</span>'
  }</td>
  <td>${oid}</td>
              <td>${userName}${
                userPhone
                  ? "<br><span style='font-size:11px;color:#9ca3af'>" +
                    userPhone +
                    "</span>"
                  : ""
              }</td>
              <td>$${Number(amount).toFixed(2)}</td>
              <td>${serviceText}<br/>${receiveText}</td>
              <td>${
                leaderName || pickupName
                  ? `${leaderName || ""}${pickupName ? " / " + pickupName : ""}`
                  : "â€”"
              }</td>
              <td>${itemCount}</td>
              <td>${renderStatusTag(o.status)}</td>
              <td>${formatDate(o.createdAt)}</td>
              <td>
  <button class="admin-btn admin-btn-ghost" data-action="detail" data-id="${o._id || o.id || oid}">è¯¦æƒ…</button>
  <button class="admin-btn admin-btn-ghost" data-action="print"  data-id="${o._id || o.id || oid}">æ‰“å°</button>
  <button class="admin-btn admin-btn-ghost" data-action="done"   data-id="${o._id || o.id || ""}">æ ‡è®°å®Œæˆ</button>
</td>

            `;
            tbody.appendChild(tr);
          });
        }

        const gmv = computeGMV(currentOrdersCache);
        document.getElementById("ordersSummary").textContent = `å…± ${total} ç¬”è®¢å•`;
        document.getElementById("pageInfo").textContent = `ç¬¬ ${currentPage} / ${totalPagesValue} é¡µ`;
        document.getElementById("btnPrevPage").disabled = currentPage <= 1;
        document.getElementById("btnNextPage").disabled = currentPage >= totalPagesValue;
        document.getElementById("gmvSummary").innerHTML =
          `å½“å‰ç­›é€‰ GMVï¼š<span class="stat-highlight">$${gmv.toFixed(2)}</span>`;
      }
      // âœ… è®¢å•è¡¨æ ¼æ“ä½œï¼šäº‹ä»¶ä»£ç†ï¼ˆä¿®å¤ CSP ç¦æ­¢ inline onclick å¯¼è‡´â€œç‚¹äº†æ²¡ååº”â€ï¼‰
function bindOrderTableActions() {
  // é˜²é‡å¤ç»‘å®šï¼ˆç»‘åœ¨ document ä¸Šï¼‰
  if (window.__ordersActionBound) return;
  window.__ordersActionBound = true;

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("#ordersTableBody button[data-action]");
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;

    if (!id) {
      alert("æŒ‰é’®ç¼ºå°‘ data-idï¼Œæ— æ³•æ“ä½œ");
      return;
    }

    if (action === "detail") return viewOrderDetail(id);
    if (action === "print") return printOrder(id);
    if (action === "done") return markOrderCompleted(id);
  });

  console.log("âœ… bindOrderTableActions: bound on document");
}
      // âœ… æ‹‰å–è®¢å•åˆ—è¡¨
      async function loadOrders(page = 1) {
        currentPage = page;
        const tbody = document.getElementById("ordersTableBody");
        tbody.innerHTML = '<tr><td colspan="10">æ­£åœ¨åŠ è½½è®¢å•...</td></tr>';

        const keyword = document.getElementById("searchKeyword").value.trim();
        const status = document.getElementById("filterStatus").value || "";

        // âœ… æ”¶è´§æ–¹å¼ï¼ˆdoor/pickupï¼‰â€”â€”ä¸ä¼ ç»™åç«¯ï¼Œå‰ç«¯è¿‡æ»¤ï¼Œé¿å… â€œçˆ†å“æ—¥é€è´§ä¸Šé—¨æŸ¥ä¸åˆ°â€
        const receiveFilter = document.getElementById("filterDelivery").value || "";

        // âœ… ä¸šåŠ¡æ¨¡å¼ç­›é€‰ï¼ˆnormal/friend/areaGroupï¼‰
        const serviceModeEl = document.getElementById("filterServiceMode");
        const areaZoneEl = document.getElementById("filterAreaGroupZone");
        const serviceModeFilter = serviceModeEl ? serviceModeEl.value : "";
        const areaGroupZone = areaZoneEl ? areaZoneEl.value : "";

        const from = document.getElementById("filterFrom").value;
        const to = document.getElementById("filterTo").value;

        const params = new URLSearchParams();
        params.append("page", page);
        params.append("pageSize", pageSize);
        if (keyword) params.append("keyword", keyword);
        if (status) params.append("status", status);

        // âœ… æ³¨æ„ï¼šè¿™é‡Œä¸å† params.append("deliveryMode", receiveFilter)

        if (serviceModeFilter) params.append("serviceMode", serviceModeFilter);
        // è¿™é‡Œ areaGroupZone ä¹Ÿå¯ä¼ ç»™åç«¯ï¼ˆå³ä½¿åç«¯ä¸æ”¯æŒä¹Ÿæ²¡äº‹ï¼‰
        if (areaGroupZone) params.append("areaGroupZone", areaGroupZone);
        if (from) params.append("dateFrom", from);
        if (to) params.append("dateTo", to);

        try {
         const res = await adminFetch("/api/admin/orders?" + params.toString());
          const data = await res.json();

          if (!data.success) {
            tbody.innerHTML =
              '<tr><td colspan="10">åŠ è½½å¤±è´¥ï¼š' + (data.message || "æœªçŸ¥é”™è¯¯") + "</td></tr>";
            return;
          }

          const list = data.list || data.orders || [];
          const total = data.total || list.length;
          totalPages = data.totalPages || 1;

          // âœ… æ¯æ¬¡æ‹¿åˆ° listï¼Œå°±ç”¨çœŸå® zoneId åˆ·æ–°â€œåŒºåŸŸä¸‹æ‹‰â€
          // åªåœ¨åŒºåŸŸå›¢æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼Œä½†æˆ‘ä»¬ä¾ç„¶åˆ·æ–° optionsï¼Œé¿å…åˆ‡æ¢æ—¶ç©ºç™½
          refreshAreaGroupZoneSelect(areaZoneEl, list, true);

          // âœ… å‰ç«¯äºŒæ¬¡ç­›é€‰ï¼ˆå…³é”®ï¼‰
          let filtered = [...list];

          // 1) æ”¶è´§æ–¹å¼ï¼šdoor / pickup
          if (receiveFilter) {
            filtered = filtered.filter((o) => getDeliveryType(o) === receiveFilter);
          }

          // 2) ä¸šåŠ¡æ¨¡å¼ï¼šæŠŠâ€œçˆ†å“æ—¥â€å½’ç±»åˆ°â€œåŒºåŸŸå›¢â€
          if (serviceModeFilter) {
            if (serviceModeFilter === "areaGroup") {
              filtered = filtered.filter((o) => {
                const sm = getServiceMode(o);
                return sm === "groupDay" || sm === "dealsDay";
              });
            } else if (serviceModeFilter === "friend") {
              filtered = filtered.filter((o) => getServiceMode(o) === "friendGroup");
            } else if (serviceModeFilter === "normal") {
              filtered = filtered.filter((o) => getServiceMode(o) === "normal");
            }
          }

          // 3) âœ… åŒºåŸŸç­›é€‰ï¼šçœŸæ­£æŒ‰ zoneId åŒºåˆ†
          if (serviceModeFilter === "areaGroup" && areaGroupZone) {
            filtered = filtered.filter((o) => getZoneIdFromOrder(o) === String(areaGroupZone).trim());
          }

          currentOrdersCache = filtered;

          if (!currentOrdersCache.length) {
            tbody.innerHTML = '<tr><td colspan="10">æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®¢å•</td></tr>';
            document.getElementById("gmvSummary").innerHTML =
              'å½“å‰ç­›é€‰ GMVï¼š<span class="stat-highlight">$0.00</span>';
            document.getElementById("ordersSummary").textContent = `å…± 0 ç¬”è®¢å•`;
            document.getElementById("pageInfo").textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            document.getElementById("btnPrevPage").disabled = true;
            document.getElementById("btnNextPage").disabled = true;
            return;
          }

          renderTableFromCache(total, totalPages);
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="10">è¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ /api/admin/orders æ˜¯å¦å¯ç”¨</td></tr>';
        }
      bindCheckAll();
      }
     
      // âœ… è®¢å•è¯¦æƒ…ï¼ˆä»å½“å‰é¡µç¼“å­˜å–ï¼‰
      function viewOrderDetail(idOrNo) {
        const panel = document.getElementById("orderDetailPanel");
        const main = document.getElementById("orderDetailMain");
        const listBox = document.getElementById("orderItemList");
        const seqBox = document.getElementById("orderDetailSeqBox");
        const seqValueEl = document.getElementById("orderDetailSeqValue");

        const o =
          currentOrdersCache.find(
            (x) => x._id === idOrNo || x.id === idOrNo || x.orderNo === idOrNo
          ) || null;

        if (!o) {
          panel.classList.add("active");
          main.innerHTML =
            '<div class="order-detail-row">æœªåœ¨å½“å‰é¡µç¼“å­˜ä¸­æ‰¾åˆ°è¯¥è®¢å•ã€‚</div>';
          listBox.innerHTML =
            '<div class="order-detail-row">æ²¡æœ‰å•†å“ä¿¡æ¯ã€‚</div>';
          if (seqBox) seqBox.style.display = "none";
          return;
        }

        const amount =
          typeof o.totalAmount === "number" ? o.totalAmount : o.amount || 0;
        const userName = (o.user && o.user.name) || o.customerName || "â€”";
        const userPhone = (o.user && o.user.phone) || o.customerPhone || "";
        const leaderName = (o.leader && o.leader.name) || o.leaderName || "";
        const pickupName = o.pickupName || "";
        const address = o.address || o.shippingAddress || "â€”";
        const remark = o.remark || "â€”";

        const payMethod = formatPayMethod(o.payMethod);
        const seq = getOrderSeq(o);

        const serviceText = renderServiceModeLabel(getServiceMode(o));
        const receiveText =
          getDeliveryType(o) === "pickup" ? "å›¢é•¿è‡ªæ" : "é€è´§ä¸Šé—¨";

        if (seqBox && seqValueEl) {
          if (seq != null) {
            seqBox.style.display = "block";
            seqValueEl.textContent = seq;
          } else {
            seqBox.style.display = "none";
          }
        }

        main.innerHTML = `
          <div class="order-detail-row">
            <span class="order-detail-label">è®¢å•å·:</span> ${o.orderNo || o._id}
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">ç”¨æˆ·:</span> ${userName}${
              userPhone ? "ï¼ˆ" + userPhone + "ï¼‰" : ""
            }
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">é‡‘é¢:</span> $${Number(amount).toFixed(2)}
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">é…é€æ–¹å¼:</span> ${serviceText} / ${receiveText}
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">æ”¯ä»˜æ–¹å¼:</span>
            <span class="pay-pill">${payMethod}</span>
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">å›¢é•¿/è‡ªæç‚¹:</span>
            ${leaderName || pickupName || "â€”"}
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">æ”¶è´§åœ°å€:</span> ${address}
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">å¤‡æ³¨:</span> ${remark}
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">ä¸‹å•æ—¶é—´:</span> ${formatDate(o.createdAt)}
          </div>
        `;

        if (!o.items || !o.items.length) {
          listBox.innerHTML = '<div class="order-detail-row">æ²¡æœ‰å•†å“ä¿¡æ¯ã€‚</div>';
        } else {
          listBox.innerHTML = "";
          o.items.forEach((it) => {
            const row = document.createElement("div");
            row.className = "order-detail-row";
            const name = it.name || it.productName || "å•†å“";
            const qty = it.qty || it.quantity || 1;
            const price = it.price || it.unitPrice || 0;
            row.innerHTML = `
              ${name} Ã— ${qty}
              <span style="float:right">$${Number(price).toFixed(2)}</span>
            `;
            listBox.appendChild(row);
          });
        }

        panel.classList.add("active");
      }

      // âœ… æ‰“å°å•ä¸ªè®¢å•å°ç¥¨ï¼ˆä»å½“å‰é¡µç¼“å­˜å–ï¼‰
      function printOrder(idOrNo) {
        const o =
          currentOrdersCache.find(
            (x) => x._id === idOrNo || x.id === idOrNo || x.orderNo === idOrNo
          ) || null;

        if (!o) {
          alert("æœªåœ¨å½“å‰é¡µç¼“å­˜ä¸­æ‰¾åˆ°è¯¥è®¢å•ï¼Œè¯·åˆ·æ–°åé‡è¯•ã€‚");
          return;
        }

        const orderId = o.orderNo || o._id || "";
        const amount =
          typeof o.totalAmount === "number" ? o.totalAmount : o.amount || 0;
        const rawUserName = (o.user && o.user.name) || o.customerName || "â€”";
        const rawUserPhone = (o.user && o.user.phone) || o.customerPhone || "";
        const userName = maskName(rawUserName);
        const userPhone = maskPhone(rawUserPhone);
        const address = o.address || o.shippingAddress || "â€”";
        const items = o.items || [];
        const deliveryFee = Number(o.deliveryFee || o.shippingFee || 0);
        const createdAt = o.createdAt;
        const payMethod = formatPayMethod(o.payMethod);
        const seq = getOrderSeq(o);

        const serviceText = renderServiceModeLabel(getServiceMode(o));
        const receiveText =
          getDeliveryType(o) === "pickup" ? "å›¢é•¿è‡ªæ" : "é€è´§ä¸Šé—¨";
        const deliveryModeText = `${serviceText} / ${receiveText}`;

        const printHtml = `
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>è®¢å•å°ç¥¨ - ${orderId}</title>
              <style>
                body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
                  padding: 16px;
                  color: #111827;
                }
                h1 { font-size: 18px; margin-bottom: 8px; }
                .seq-box {
                  margin-bottom: 8px;
                  padding: 6px 8px;
                  border-radius: 8px;
                  border: 1px solid #16a34a;
                  background: #dcfce7;
                  text-align: center;
                }
                .seq-label { font-size: 11px; color: #166534; letter-spacing: 1px; }
                .seq-value { font-size: 26px; font-weight: 900; color: #166534; line-height: 1.1; }
                .meta { font-size: 12px; margin-bottom: 10px; }
                .meta div { margin-bottom: 2px; }
                table {
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 12px;
                  margin-top: 6px;
                }
                th, td { border: 1px solid #e5e7eb; padding: 4px 6px; }
                th { background: #f9fafb; }
                .total { margin-top: 10px; font-size: 13px; text-align: right; }
                .total strong { font-size: 14px; }
              </style>
            </head>
            <body>
              <h1>åœ¨é²œè´­æ‹¼å¥½è´§ Â· é…è´§å°ç¥¨</h1>

              <div class="seq-box">
                <div class="seq-label">é…é€åºå·</div>
                <div class="seq-value">${seq != null ? seq : "-"}</div>
              </div>

              <div class="meta">
                <div>è®¢å•å·ï¼š${orderId}</div>
                <div>ä¸‹å•æ—¶é—´ï¼š${formatDate(createdAt)}</div>
                <div>å®¢æˆ·å§“åï¼š${userName}</div>
                <div>è”ç³»ç”µè¯ï¼š${userPhone}</div>
                <div>é…é€æ–¹å¼ï¼š${deliveryModeText}</div>
                <div>æ”¶è´§åœ°å€ï¼š${address}</div>
                <div>æ”¯ä»˜æ–¹å¼ï¼š${payMethod}</div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>å•†å“</th>
                    <th>æ•°é‡</th>
                    <th>å•ä»·</th>
                    <th>å°è®¡</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    items
                      .map((it) => {
                        const name = it.name || it.productName || "å•†å“";
                        const qty = it.qty || it.quantity || 1;
                        const price = Number(it.price || it.unitPrice || 0);
                        const subtotal = price * qty;
                        return `
                          <tr>
                            <td>${name}</td>
                            <td>${qty}</td>
                            <td>$${price.toFixed(2)}</td>
                            <td>$${subtotal.toFixed(2)}</td>
                          </tr>
                        `;
                      })
                      .join("") || ""
                  }
                </tbody>
              </table>

              <div class="total">
                å•†å“æ€»é¢ï¼š$${Number(amount).toFixed(2)}<br/>
                é…é€è´¹ï¼š$${deliveryFee.toFixed(2)}<br/>
                <strong>åº”ä»˜æ€»é¢ï¼š$${(Number(amount) + deliveryFee).toFixed(2)}</strong>
              </div>
            </body>
          </html>
        `;

        const win = window.open("", "_blank");
        if (!win) {
          alert("æµè§ˆå™¨æ‹¦æˆªäº†æ‰“å°çª—å£ï¼Œè¯·å…è®¸å¼¹å‡ºçª—å£åé‡è¯•ã€‚");
          return;
        }
        win.document.write(printHtml);
        win.document.close();
        win.focus();
        win.print();
        win.close();
      }

      // âœ… æ ‡è®°è®¢å•å®Œæˆ
      async function markOrderCompleted(orderId) {
        if (!orderId) {
          alert("ç¼ºå°‘è®¢å• ID");
          return;
        }
        if (!confirm("ç¡®å®šå°†è¯¥è®¢å•æ ‡è®°ä¸ºå·²å®Œæˆï¼Ÿ")) return;

        try {
          const res = await adminFetch("/api/admin/orders/" + orderId + "/status", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "done" }),
          });
          const data = await res.json();
          if (!data.success) {
            alert("æ›´æ–°å¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
            return;
          }
          loadOrders(currentPage);
        } catch (e) {
          console.error(e);
          alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ /api/admin/orders/:id/status æ¥å£");
        }
      }

      // âœ… Google è·¯çº¿æ™ºèƒ½æ’åºï¼ˆåªå¯¹å½“å‰é¡µ + é€è´§ä¸Šé—¨è®¢å•ï¼‰
      function ensureDirectionsService() {
        if (!window.google || !google.maps) {
          alert("Google Maps è„šæœ¬æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ API Key");
          return null;
        }
        if (!directionsService) directionsService = new google.maps.DirectionsService();
        return directionsService;
      }

      async function optimizeRouteForCurrentPage() {
        const svc = ensureDirectionsService();
        if (!svc) return;

        if (!currentOrdersCache.length) {
          alert("å½“å‰æ²¡æœ‰è®¢å•ï¼Œæ— éœ€æ’åº");
          return;
        }

        const doorOrders = currentOrdersCache.filter((o) => getDeliveryType(o) === "door");

        if (doorOrders.length <= 1) {
          let seq = 1;
          currentOrdersCache.forEach((o) => (o.routeSeq = seq++));
          renderTableFromCache(currentOrdersCache.length, totalPages);
          alert("é€è´§ä¸Šé—¨è®¢å•å°‘äº 2 å•ï¼Œå·²æŒ‰å½“å‰é¡ºåºç®€å•ç¼–å·ã€‚");
          return;
        }

        const buildLocation = (o) => {
          if (typeof o.lat === "number" && typeof o.lng === "number") {
            return new google.maps.LatLng(o.lat, o.lng);
          }
          const addr = buildOrderAddress(o);
          return addr || null;
        };

        const waypoints = [];
        const waypointOrders = [];
        doorOrders.forEach((o) => {
          const loc = buildLocation(o);
          if (loc) {
            waypoints.push({ location: loc, stopover: true });
            waypointOrders.push(o);
          }
        });

        if (waypoints.length <= 1) {
          let seq = 1;
          currentOrdersCache.forEach((o) => (o.routeSeq = seq++));
          renderTableFromCache(currentOrdersCache.length, totalPages);
          alert("æœ‰æ•ˆåœ°å€çš„é€è´§ä¸Šé—¨è®¢å•ä¸è¶³ 2 å•ï¼Œå·²æŒ‰å½“å‰é¡ºåºç¼–å·ã€‚");
          return;
        }

        const warehouse = new google.maps.LatLng(40.758531, -73.829252);
        const req = {
          origin: warehouse,
          destination: warehouse,
          waypoints,
          travelMode: google.maps.TravelMode.DRIVING,
          optimizeWaypoints: true,
        };

        document.getElementById("gmvSummary").innerHTML =
          "æ­£åœ¨è°ƒç”¨ Google è·¯çº¿ä¼˜åŒ–ï¼Œè¯·ç¨å€™...";

        svc.route(req, (result, status) => {
          if (status !== google.maps.DirectionsStatus.OK) {
            console.warn("Directions å¤±è´¥:", status, result);
            alert("Google è·¯çº¿ä¼˜åŒ–å¤±è´¥ï¼š" + status + "ï¼Œå·²ä¿æŒåŸé¡ºåºã€‚");
            renderTableFromCache(currentOrdersCache.length, totalPages);
            return;
          }

          const order = result.routes[0].waypoint_order || [];
          const sortedDoor = order.map((idx) => waypointOrders[idx]);
          const nonDoor = currentOrdersCache.filter((o) => !doorOrders.includes(o));

          let seq = 1;
          const newList = [];
          sortedDoor.forEach((o) => {
            o.routeSeq = seq++;
            newList.push(o);
          });
          nonDoor.forEach((o) => {
            o.routeSeq = seq++;
            newList.push(o);
          });

          currentOrdersCache = newList;
          renderTableFromCache(currentOrdersCache.length, totalPages);
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        bindOrderTableActions();
        // âœ… å…ˆæŠŠ zoneId->zoneName æ‹‰ä¸‹æ¥ï¼Œè¿™æ ·ä¸‹æ‹‰æ¡†å°±èƒ½æ˜¾ç¤ºä¸­æ–‡
  await loadZoneNameMap();
        loadOrders(1);     
        document.getElementById("btnSearch").addEventListener("click", () => loadOrders(1));
        document.getElementById("btnRefresh").addEventListener("click", () => loadOrders(currentPage));
        document.getElementById("btnPrevPage").addEventListener("click", () => {
          if (currentPage > 1) loadOrders(currentPage - 1);
        });
        document.getElementById("btnNextPage").addEventListener("click", () => {
          if (currentPage < totalPages) loadOrders(currentPage + 1);
        });

        const serviceModeSelect = document.getElementById("filterServiceMode");
        const areaZoneSelect = document.getElementById("filterAreaGroupZone");

        if (serviceModeSelect && areaZoneSelect) {
          serviceModeSelect.addEventListener("change", () => {
            if (serviceModeSelect.value === "areaGroup") {
              areaZoneSelect.style.display = "inline-block";
            } else {
              areaZoneSelect.style.display = "none";
              areaZoneSelect.value = "";
            }
            loadOrders(1);
          });

          areaZoneSelect.addEventListener("change", () => loadOrders(1));
        }

        const btnPrintOrderList = document.getElementById("btnPrintOrderList");
        if (btnPrintOrderList) btnPrintOrderList.addEventListener("click", printOrderList);

        const btnGoPicklist = document.getElementById("btnGoPicklist");
        if (btnGoPicklist) {
          btnGoPicklist.addEventListener("click", () => {
            window.location.href = "picklist.html";
          });
        }

        const btnOptimizeRoute = document.getElementById("btnOptimizeRoute");
        if (btnOptimizeRoute) btnOptimizeRoute.addEventListener("click", optimizeRouteForCurrentPage);
      const btnPackBatch = document.getElementById("btnPackBatch");
if (btnPackBatch) btnPackBatch.addEventListener("click", packSelectedOrders);
      });
    </script>
   <!-- âœ… ç»Ÿä¸€ sidebar æ³¨å…¥è„šæœ¬ï¼ˆå¿…é¡»åŠ ï¼‰ -->
    <script src="/admin/assets/js/admin_sidebar.js"></script>
</body>
</html>
