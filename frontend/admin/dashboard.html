<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>åœ¨é²œè´­æ‹¼å¥½è´§ - åå°ä»ªè¡¨ç›˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/css/admin.css" />
  </head>

  <!-- â­ data-page ç”¨äºé«˜äº®èœå• -->
  <body data-page="dashboard">
    <div class="admin-layout">
      <!-- å·¦ä¾§ä¾§è¾¹æ  -->
      <aside class="admin-sidebar">
        <div id="adminSidebar"></div>
      </aside>

      <!-- å³ä¾§ä¸»åŒºåŸŸ -->
      <div class="admin-main">
        <!-- é¡¶éƒ¨æ  -->
        <header class="admin-topbar">
          <!-- â­ åŠ ä¸Š admin-topbar-toggleï¼Œé…åˆ CSS åœ¨å°å±æ˜¾ç¤º -->
          <button class="admin-btn admin-btn-ghost admin-topbar-toggle" data-toggle-sidebar>
            â˜°
          </button>

          <div class="admin-topbar-title">ä»ªè¡¨ç›˜</div>
          <div class="admin-topbar-spacer"></div>

          <div class="admin-search">
            <span class="admin-search-icon">ğŸ”</span>
            <input type="text" placeholder="æœç´¢è®¢å• / ç”¨æˆ· / å•†å“..." />
          </div>

          <div class="admin-user">
            <div class="admin-user-avatar">A</div>
            <div class="admin-user-info">
              <span class="admin-user-name">Admin</span>
              <span class="admin-user-role">è¶…çº§ç®¡ç†å‘˜</span>
            </div>
          </div>
        </header>

        <!-- å†…å®¹ -->
        <main class="admin-content">
          <!-- é¡µé¢æ ‡é¢˜ -->
          <div class="admin-page-header">
            <div>
              <div class="admin-page-title">ä»Šæ—¥æ¦‚è§ˆ</div>
              <div class="admin-breadcrumb">åå° &gt; ä»ªè¡¨ç›˜</div>
            </div>

            <div class="admin-page-actions">
              <button class="admin-btn admin-btn-ghost" id="btn-refresh">âŸ³ åˆ·æ–°æ•°æ®</button>
              <button class="admin-btn admin-btn-primary">â¬‡ å¯¼å‡ºä»Šæ—¥æŠ¥è¡¨</button>
            </div>
          </div>

          <!-- æŒ‡æ ‡å¡ç‰‡ -->
          <section class="admin-grid">
            <article class="admin-card">
              <div class="admin-card-title">ä»Šæ—¥ GMV</div>
              <div class="stat-value" id="stat-revenue">$0</div>
              <div class="admin-card-sub">è¾ƒæ˜¨æ—¥ +18.2%</div>
            </article>

            <article class="admin-card admin-card-ghost">
              <div class="admin-card-title">ä»Šæ—¥è®¢å•æ•°</div>
              <div class="admin-card-value" id="stat-orders">0</div>
              <div class="admin-card-sub">å¾…é…é€ 42 Â· è‡ªæ 96</div>
            </article>

            <article class="admin-card admin-card-ghost">
              <div class="admin-card-title">æ–°æ³¨å†Œç”¨æˆ·</div>
              <div class="admin-card-value" id="stat-users">0</div>
              <div class="admin-card-sub">å›¢é•¿é‚€è¯· 31 Â· è‡ªç„¶ 17</div>
            </article>

            <article class="admin-card admin-card-ghost">
              <div class="admin-card-title">æ‹¼å•è¿›è¡Œä¸­</div>
              <div class="admin-card-value" id="stat-groups">0</div>
              <div class="admin-card-sub">é¢„è®¡ä»Šæ™š 9:00 æˆªæ­¢</div>
            </article>
          </section>

          <!-- è¡¨æ ¼ã€å›¾è¡¨åŒºåŸŸ -->
          <section class="admin-2col">
            <!-- å·¦ï¼šè®¢å•è¡¨æ ¼ -->
            <section class="admin-table-card">
              <div class="admin-card-header">
                <div>
                  <div class="admin-card-header-title">æœ€æ–°è®¢å•</div>
                  <div class="admin-card-header-sub">æœ€è¿‘ 10 ç¬”è®¢å•ï¼ˆå·²æ”¯ä»˜ï¼‰</div>
                </div>
                <button class="admin-btn admin-btn-ghost" onclick="location.href='orders.html'">
                  æŸ¥çœ‹å…¨éƒ¨è®¢å• â†’
                </button>
              </div>

              <div class="admin-table-wrapper">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>è®¢å•å·</th>
                      <th>ç”¨æˆ·</th>
                      <th>é‡‘é¢</th>
                      <th>é…é€æ–¹å¼</th>
                      <th>çŠ¶æ€</th>
                      <th>å¸æœº</th>
                      <th>æ´¾å•</th>
                    </tr>
                  </thead>
                  <tbody id="recentOrdersTbody">
                    <tr>
                      <td colspan="7" style="color:#9ca3af;">åŠ è½½ä¸­...</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="admin-pagination">
                <span>å…± 326 ç¬”</span>
                <button class="admin-btn admin-btn-ghost">Â«</button>
                <button class="admin-btn admin-btn-primary">1</button>
                <button class="admin-btn admin-btn-ghost">2</button>
                <button class="admin-btn admin-btn-ghost">3</button>
                <button class="admin-btn admin-btn-ghost">Â»</button>
              </div>
            </section>

            <!-- å³ï¼šå ä½å¡ç‰‡ï¼ˆåé¢å¯ä»¥åµŒå›¾è¡¨ï¼‰ -->
            <section class="admin-table-card">
              <div class="admin-card-header">
                <div>
                  <div class="admin-card-header-title">æ‹¼å•è¿›åº¦ä¸€è§ˆ</div>
                  <div class="admin-card-header-sub">åç»­å¯ä»¥æ¥ Chart.js å›¾è¡¨</div>
                </div>
              </div>
              <p style="font-size:12px;color:#9ca3af;margin-top:2px;line-height:1.5;">
                å ä½è¯´æ˜ï¼šåç»­æ¥å…¥æ¥å£åï¼Œè¿™é‡Œå¯ä»¥å±•ç¤º
                <strong>æ‹¼å•è¾¾æˆç‡ã€çƒ­é—¨çˆ†å“ã€å›¢é•¿è¡¨ç°</strong> ç­‰å¯è§†åŒ–å›¾è¡¨ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹è¿è¥æƒ…å†µã€‚
              </p>
            </section>
          </section>
        </main>
      </div>
    </div>

    <!-- âœ… é€šç”¨ UI è¡Œä¸ºï¼ˆä¾§è¾¹æ æŠ˜å ç­‰ï¼‰ -->
    <script src="assets/js/admin.js"></script>

    <!-- âœ… å…ˆåšç®¡ç†å‘˜å®ˆå«ï¼ˆç»Ÿä¸€ï¼‰ -->
    <script src="/admin/assets/js/admin_guard.js"></script>
    <script src="./assets/js/admin_auth_ui.js"></script>
    <!-- âœ… å†æ³¨å…¥ sidebarï¼ˆé«˜äº® data-pageï¼‰ -->
    <script src="/admin/assets/js/admin_sidebar.js"></script>

    <script>
      // =========================
      // 1) token å·¥å…· & apiFetchï¼ˆä¿ç•™ï¼Œç”¨äºæœ¬é¡µè¯·æ±‚æ¥å£ï¼‰
      // =========================
      function getAdminToken() {
        return (
          localStorage.getItem("freshbuy_token") ||
          localStorage.getItem("admin_token") ||
          localStorage.getItem("token") ||
          localStorage.getItem("auth_token") ||
          ""
        );
      }

      async function apiFetch(path, options = {}) {
        const token = getAdminToken();
        const headers = new Headers(options.headers || {});
        if (token) headers.set("Authorization", "Bearer " + token);
        if (!headers.has("Content-Type") && !(options.body instanceof FormData)) {
          headers.set("Content-Type", "application/json");
        }

        const res = await fetch(path, { ...options, headers, credentials: "include" });
        const text = await res.text();
        let json = {};
        try { json = text ? JSON.parse(text) : {}; } catch { json = {}; }

        if (!res.ok) throw new Error(json.message || json.msg || ("HTTP " + res.status));
        if (json && json.success === false) throw new Error(json.message || json.msg || "è¯·æ±‚å¤±è´¥");
        return json;
      }

      // =========================
      // 2) ä»ªè¡¨ç›˜ summaryï¼ˆDBï¼‰
      // =========================
      async function loadDashboardSummary() {
        try {
          const data = await apiFetch("/api/admin/dashboard/summary", { method: "GET" });
          const d = data.data || {};

          const revenueEl = document.getElementById("stat-revenue");
          if (revenueEl) revenueEl.textContent = `$${Number(d.revenueToday || 0).toFixed(2)}`;

          const orderEl = document.getElementById("stat-orders");
          if (orderEl) orderEl.textContent = d.orderToday ?? d.orderTotal ?? 0;

          const userEl = document.getElementById("stat-users");
          if (userEl) userEl.textContent = d.userTotal ?? 0;

          const groupEl = document.getElementById("stat-groups");
          if (groupEl) groupEl.textContent = d.groupsActive ?? 0;
        } catch (err) {
          console.error("ä»ªè¡¨ç›˜ summary åŠ è½½å¤±è´¥:", err);
        }
      }

      // =========================
      // 3) æœ€æ–°è®¢å•ï¼ˆDBï¼‰
      // =========================
      function money(n) {
        const x = Number(n);
        return "$" + (isFinite(x) ? x.toFixed(2) : "0.00");
      }

      function statusTag(status) {
        const s = String(status || "").toLowerCase();
        if (["done", "delivered", "completed", "finished"].includes(s)) {
          return `<span class="admin-tag admin-tag-success">å·²å®Œæˆ</span>`;
        }
        if (["shipping", "assigned", "dispatching", "delivering"].includes(s)) {
          return `<span class="admin-tag admin-tag-warning">é…é€ä¸­</span>`;
        }
        if (["cancel", "cancelled", "canceled"].includes(s)) {
          return `<span class="admin-tag admin-tag-danger">å·²å–æ¶ˆ</span>`;
        }
        if (["pending", "unpaid", "created"].includes(s)) {
          return `<span class="admin-tag admin-tag-warning">å¾…é…é€</span>`;
        }
        return `<span class="admin-tag">` + (status || "æœªçŸ¥") + `</span>`;
      }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function loadRecentOrders() {
        const tbody = document.getElementById("recentOrdersTbody");
        if (!tbody) return;

        try {
          tbody.innerHTML = `<tr><td colspan="7" style="color:#9ca3af;">åŠ è½½ä¸­...</td></tr>`;

          const r = await apiFetch("/api/admin/dashboard/recent-orders?limit=10", { method: "GET" });
          const list = r.orders || r.data || r.items || r.list || [];

          if (!Array.isArray(list) || list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="color:#9ca3af;">æš‚æ— è®¢å•</td></tr>`;
            return;
          }

          tbody.innerHTML = "";
          list.forEach((o) => {
            const orderNo = o.orderNo || o.no || o.order_number || o.id || "--";
            const userName = o.userName || o.user || o.customerName || "â€”";
            const amount = money(o.amount ?? o.totalAmount ?? o.total ?? 0);
            const deliveryType = o.deliveryType || o.mode || o.delivery_type || "â€”";
            const statusHtml = statusTag(o.status);

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>#${escapeHtml(orderNo)}</td>
              <td>${escapeHtml(userName)}</td>
              <td>${escapeHtml(amount)}</td>
              <td>${escapeHtml(deliveryType)}</td>
              <td>${statusHtml}</td>
              <td><span style="color:#9ca3af;">â€”</span></td>
              <td><span style="color:#9ca3af;">â€”</span></td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("æœ€æ–°è®¢å•åŠ è½½å¤±è´¥:", err);
          tbody.innerHTML = `<tr><td colspan="7" style="color:#ef4444;">åŠ è½½å¤±è´¥ï¼š${escapeHtml(err.message || "")}</td></tr>`;
        }
      }

      // =========================
      // 4) é¡µé¢å…¥å£ï¼šå…ˆç»Ÿä¸€ admin_guardï¼Œå†åŠ è½½æ•°æ®
      // =========================
      window.addEventListener("DOMContentLoaded", async () => {
        // âœ… ç»Ÿä¸€å®ˆå«ï¼šä¸æ˜¯ admin ä¼šè‡ªåŠ¨è·³ login
        if (window.adminGuard) {
          const ok = await window.adminGuard();
          if (!ok) return;
        }

        await loadDashboardSummary();
        await loadRecentOrders();

        const btn = document.getElementById("btn-refresh");
        if (btn) {
          btn.addEventListener("click", async () => {
            await loadDashboardSummary();
            await loadRecentOrders();
          });
        }
      });
    </script>
  </body>
</html>
