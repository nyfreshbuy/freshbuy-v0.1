<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Zelle å……å€¼å®¡æ ¸ - Freshbuy Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="../user/assets/css/main.css" />
  <style>
    body { background:#f3f4f6; }
    .wrap{ max-width: 980px; margin: 20px auto; padding: 0 14px; }
    .card{ background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:16px; }
    .title{ font-size:18px; font-weight:800; color:#111827; margin-bottom:12px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .btn{ border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800; }
    .btn-ghost{ background:#eef2ff; color:#111827; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th,td{ padding:10px 8px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
    th{ text-align:left; color:#475569; font-size:12px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-ok{ background:#22c55e; color:#fff; }
    .btn-no{ background:#ef4444; color:#fff; }
    .muted{ color:#64748b; font-size:12px; }
    .remark{ white-space:pre-wrap; max-width:420px; }
    .topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input.note{ padding:9px 10px; border:1px solid #e5e7eb; border-radius:12px; width:260px; }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; color:#0f172a; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <div>ğŸ’¸ Zelle å……å€¼å®¡æ ¸ï¼ˆPendingï¼‰ <span class="badge" id="countBadge">0</span></div>
        <div class="topbar">
          <input class="note" id="adminNote" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ï¼šå·²åˆ°è´¦ 1/25ï¼‰" />
          <button class="btn btn-ghost" id="btnRefresh">åˆ·æ–°</button>
        </div>
      </div>

      <div class="muted" id="statusText">åŠ è½½ä¸­â€¦</div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>æ—¶é—´</th>
              <th>ç”¨æˆ·</th>
              <th>é‡‘é¢</th>
              <th>å¤‡æ³¨ï¼ˆref/memoï¼‰</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // âœ… ç®¡ç†å‘˜ token å…œåº•ï¼ˆæŒ‰ä½ é¡¹ç›®å¯èƒ½çš„ key æ¥ï¼‰
  function getAdminToken(){
    return (
      localStorage.getItem("admin_token") ||
      localStorage.getItem("adminToken") ||
      localStorage.getItem("token") ||
      ""
    );
  }

  function fmtTime(s){
    try { return new Date(s).toLocaleString(); } catch(e){ return String(s||""); }
  }

  function esc(s){
    return String(s ?? "").replace(/[<>&"]/g, (c) => ({
      "<":"&lt;", ">":"&gt;", "&":"&amp;", '"':"&quot;"
    }[c]));
  }

  async function api(url, opts={}){
    const token = getAdminToken();
    const headers = Object.assign(
      { "Content-Type":"application/json" },
      opts.headers || {},
      token ? { Authorization: "Bearer " + token } : {}
    );
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.message || ("HTTP " + res.status));
    return data;
  }

  const tbody = document.getElementById("tbody");
  const statusText = document.getElementById("statusText");
  const adminNote = document.getElementById("adminNote");
  const countBadge = document.getElementById("countBadge");

  // âœ… äºŒæ¬¡ç¡®è®¤ï¼šé˜²è¯¯ç‚¹ï¼ˆè¾“å…¥ CONFIRM æ‰æ‰§è¡Œï¼‰
  function strongConfirm(action, amount){
    const tip = action === "approve"
      ? `ç¡®è®¤è¦ã€é€šè¿‡å…¥è´¦ã€‘ $${amount.toFixed(2)} å—ï¼Ÿ\nä¸ºé˜²è¯¯ç‚¹ï¼Œè¯·è¾“å…¥ï¼šCONFIRM`
      : `ç¡®è®¤è¦ã€æ‹’ç»ã€‘ $${amount.toFixed(2)} å—ï¼Ÿ\nä¸ºé˜²è¯¯ç‚¹ï¼Œè¯·è¾“å…¥ï¼šCONFIRM`;
    const v = prompt(tip, "");
    return (v || "").trim().toUpperCase() === "CONFIRM";
  }

  async function load(){
    statusText.textContent = "åŠ è½½ä¸­â€¦";
    tbody.innerHTML = "";
    countBadge.textContent = "0";

    try{
      // âœ… åç«¯ï¼š{ success, total, items }ï¼Œitems = Recharge åŸå§‹ç»“æ„ï¼ŒuserId populate åæ˜¯å¯¹è±¡
      const data = await api("/api/admin/recharge/pending?limit=200");
      const items = data.items || [];

      countBadge.textContent = String(items.length);
      statusText.textContent = "å…± " + items.length + " æ¡ pending";

      if(items.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="muted">æš‚æ—  pending</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(r => {
        const rid = r._id || r.id || "";
        const u = r.userId || {}; // populate åï¼š{_id,name,phone}
        const userLine = (u.name || "") + (u.phone ? (" / " + u.phone) : "");
        const userIdText = (u._id || r.userId || "");
        const amt = Number(r.amount || 0);
        const remark = esc(r.remark || "");

        return `
          <tr data-id="${esc(rid)}" data-amt="${esc(String(amt))}">
            <td>${fmtTime(r.createdAt)}</td>
            <td>
              <div>${esc(userLine || String(userIdText || ""))}</div>
              <div class="muted">${esc(String(userIdText || ""))}</div>
            </td>
            <td><b>$${amt.toFixed(2)}</b></td>
            <td class="remark">${remark}</td>
            <td>
              <div class="actions">
                <button class="btn btn-ok" data-act="approve">é€šè¿‡å…¥è´¦</button>
                <button class="btn btn-no" data-act="reject">æ‹’ç»</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

    }catch(e){
      statusText.textContent = "åŠ è½½å¤±è´¥ï¼š" + (e.message || "error");
      tbody.innerHTML = '<tr><td colspan="5" class="muted">åŠ è½½å¤±è´¥</td></tr>';
    }
  }

  tbody.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-act]");
    if(!btn) return;

    const tr = ev.target.closest("tr[data-id]");
    const id = tr?.dataset?.id;
    if(!id) return;

    const act = btn.dataset.act;
    const amount = Number(tr.dataset.amt || 0) || 0;

    // âœ… äºŒæ¬¡ç¡®è®¤
    if(!strongConfirm(act, amount)) return;

    const note = (adminNote.value || "").trim();

    btn.disabled = true;
    const old = btn.textContent;
    btn.textContent = "å¤„ç†ä¸­â€¦";

    try{
      const url =
        act === "approve"
          ? ("/api/admin/recharge/" + encodeURIComponent(id) + "/approve")
          : ("/api/admin/recharge/" + encodeURIComponent(id) + "/reject");

      await api(url, {
        method:"POST",
        body: JSON.stringify({ note })
      });

      await load();
    }catch(e){
      alert(e.message || "æ“ä½œå¤±è´¥");
      btn.disabled = false;
      btn.textContent = old;
    }
  });

  document.getElementById("btnRefresh").addEventListener("click", load);

  load();
</script>
</body>
</html>
