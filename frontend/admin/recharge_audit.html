<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Zelle å……å€¼å®¡æ ¸ - Freshbuy Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="../user/assets/css/main.css" />
  <style>
    body { background:#f3f4f6; }
    .wrap{ max-width: 980px; margin: 20px auto; padding: 0 14px; }
    .card{ background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:16px; }
    .title{ font-size:18px; font-weight:800; color:#111827; margin-bottom:12px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .btn{ border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:700; }
    .btn-primary{ background:#16a34a; color:#fff; }
    .btn-ghost{ background:#eef2ff; color:#1f2937; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th,td{ padding:10px 8px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
    th{ text-align:left; color:#475569; font-size:12px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-ok{ background:#22c55e; color:#fff; }
    .btn-no{ background:#ef4444; color:#fff; }
    .muted{ color:#64748b; font-size:12px; }
    .remark{ white-space:pre-wrap; max-width:360px; }
    .topbar{ display:flex; gap:10px; align-items:center; }
    input.note{ padding:9px 10px; border:1px solid #e5e7eb; border-radius:12px; width:260px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <div>ğŸ’¸ Zelle å……å€¼å®¡æ ¸ï¼ˆPendingï¼‰</div>
        <div class="topbar">
          <input class="note" id="adminNote" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ï¼šå·²åˆ°è´¦ 1/25ï¼‰" />
          <button class="btn btn-ghost" id="btnRefresh">åˆ·æ–°</button>
        </div>
      </div>

      <div class="muted" id="statusText">åŠ è½½ä¸­â€¦</div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>æ—¶é—´</th>
              <th>ç”¨æˆ·</th>
              <th>é‡‘é¢</th>
              <th>å¤‡æ³¨ï¼ˆref/memoï¼‰</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // âœ… ç®¡ç†å‘˜ token å…œåº•ï¼ˆæŒ‰ä½ é¡¹ç›®å¯èƒ½çš„ key æ¥ï¼‰
  function getAdminToken(){
    return (
      localStorage.getItem("admin_token") ||
      localStorage.getItem("adminToken") ||
      localStorage.getItem("token") ||   // å¦‚æœä½ åå°ä¹Ÿç”¨ token
      ""
    );
  }

  function fmtTime(s){
    try { return new Date(s).toLocaleString(); } catch(e){ return String(s||""); }
  }

  async function api(url, opts={}){
    const token = getAdminToken();
    const headers = Object.assign(
      { "Content-Type":"application/json" },
      opts.headers || {},
      token ? { Authorization: "Bearer " + token } : {}
    );
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.message || ("HTTP " + res.status));
    return data;
  }

  const tbody = document.getElementById("tbody");
  const statusText = document.getElementById("statusText");
  const adminNote = document.getElementById("adminNote");

  async function load(){
    statusText.textContent = "åŠ è½½ä¸­â€¦";
    tbody.innerHTML = "";
    try{
      const data = await api("/api/admin/recharge/pending?limit=200");
      const items = data.items || [];
      statusText.textContent = "å…± " + items.length + " æ¡ pending";

      if(items.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="muted">æš‚æ—  pending</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(it => {
        const userLine = (it.userName || "") + (it.userPhone ? (" / " + it.userPhone) : "");
        return `
          <tr data-id="${it.id}">
            <td>${fmtTime(it.createdAt)}</td>
            <td>
              <div>${userLine || it.userId}</div>
              <div class="muted">${it.userId}</div>
            </td>
            <td><b>$${Number(it.amount||0).toFixed(2)}</b></td>
            <td class="remark">${(it.remark||"").replace(/</g,"&lt;")}</td>
            <td>
              <div class="actions">
                <button class="btn btn-ok" data-act="approve">é€šè¿‡å…¥è´¦</button>
                <button class="btn btn-no" data-act="reject">æ‹’ç»</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }catch(e){
      statusText.textContent = "åŠ è½½å¤±è´¥ï¼š" + e.message;
      tbody.innerHTML = '<tr><td colspan="5" class="muted">åŠ è½½å¤±è´¥</td></tr>';
    }
  }

  tbody.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-act]");
    if(!btn) return;
    const tr = ev.target.closest("tr[data-id]");
    const id = tr?.dataset?.id;
    if(!id) return;

    const act = btn.dataset.act;
    const note = (adminNote.value || "").trim();

    btn.disabled = true;
    btn.textContent = "å¤„ç†ä¸­â€¦";

    try{
      if(act === "approve"){
        await api("/api/admin/recharge/" + id + "/approve", {
          method:"POST",
          body: JSON.stringify({ note })
        });
      }else{
        await api("/api/admin/recharge/" + id + "/reject", {
          method:"POST",
          body: JSON.stringify({ note })
        });
      }
      await load();
    }catch(e){
      alert(e.message || "æ“ä½œå¤±è´¥");
      btn.disabled = false;
      btn.textContent = act === "approve" ? "é€šè¿‡å…¥è´¦" : "æ‹’ç»";
    }
  });

  document.getElementById("btnRefresh").addEventListener("click", load);

  load();
</script>
</body>
</html>
