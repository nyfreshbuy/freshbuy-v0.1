<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Freshbuy 后台 - Zone 管理（ZIP模式）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 统一后台主题 -->
  <link rel="stylesheet" href="assets/css/admin.css" />

  <!-- ✅ 本页补充样式：保留你原来的左右布局（右侧不再是地图） -->
  <style>
    .zone-wrap { display:flex; height: calc(100vh - 56px); } /* 56px 预留 topbar */
    .zone-left { width: 380px; border-right: 1px solid rgba(148,163,184,.16); padding: 16px; overflow:auto; }
    .zone-right { flex:1; position:relative; }

    /* 右侧改成提示面板 */
    .zip-only-panel{
      position:absolute; inset:0;
      border-radius: 16px;
      background: rgba(2,6,23,.35);
      border: 1px solid rgba(148,163,184,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
      overflow:auto;
    }
    .zip-only-card{
      max-width: 560px;
      width: 100%;
      padding: 18px 18px;
      border-radius: 16px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.18);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .zip-only-title{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 900;
      color: #e5e7eb;
    }
    .zip-only-desc{
      margin: 0 0 14px;
      color: #94a3b8;
      font-size: 12px;
      line-height: 1.6;
    }
    .zip-only-list{
      margin: 0;
      padding-left: 18px;
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.7;
    }
    .zip-only-badge{
      display:inline-block;
      margin-top: 12px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,.14);
      border: 1px solid rgba(34,197,94,.25);
      color:#bbf7d0;
      font-weight: 800;
    }

    .zone-h2 { margin:0 0 12px; font-size:16px; font-weight:800; color:#e5e7eb; }
    .zone-row { margin-bottom:10px; }
    .zone-row label { display:block; font-size:12px; color:#94a3b8; margin-bottom:6px; }
    .zone-row input, .zone-row textarea, .zone-row select {
      width:100%;
      padding:10px;
      border:1px solid rgba(148,163,184,.28);
      border-radius:12px;
      outline:none;
      background: rgba(2,6,23,.55);
      color:#e5e7eb;
    }
    .zone-row textarea { min-height:70px; resize:vertical; }

    .zone-btns { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .zone-btn {
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      border: 1px solid rgba(148,163,184,.28);
      background: rgba(2,6,23,.4);
      color:#e5e7eb;
      font-weight:700;
    }
    .zone-btn.primary { background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); }
    .zone-btn.ghost { background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.22); }

    .zone-hint {
      font-size:12px; color:#94a3b8; line-height:1.5; margin-top:10px;
      padding: 10px 12px; border-radius: 14px;
      border: 1px dashed rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
    }

    .zone-list { margin-top:14px; border-top: 1px solid rgba(148,163,184,.16); padding-top:12px; }

    .zone-top-actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .zone-back { white-space:nowrap; }

    /* 小屏适配 */
    @media (max-width: 980px) {
      .zone-wrap { flex-direction: column; height:auto; }
      .zone-left { width:100%; border-right:none; border-bottom:1px solid rgba(148,163,184,.16); }
      .zone-right { height: 48vh; }
      .zip-only-panel{ position:relative; inset:auto; height:48vh; }
    }
  </style>
</head>

<body class="admin-layout" data-page="zones">
  <!-- ✅ 统一侧边栏：由 admin_sidebar.js 注入 -->
  <aside class="admin-sidebar">
    <div id="adminSidebar"></div>
  </aside>

  <div class="admin-main">
    <!-- ✅ 顶部栏 -->
    <header class="admin-topbar">
      <button class="admin-btn admin-btn-ghost" data-toggle-sidebar>☰</button>
      <div class="admin-topbar-title">配送区域 Zone（ZIP模式）</div>
      <div class="admin-topbar-spacer"></div>

      <a class="admin-btn admin-btn-ghost zone-back" href="dashboard.html" id="btnBackTop">← 返回后台</a>
    </header>

    <main class="admin-content" style="padding-top: 12px;">
      <section class="admin-card admin-card-ghost" style="padding:0; overflow:hidden;">
        <div class="zone-wrap">

          <!-- 左：表单 -->
          <div class="zone-left">
            <div class="zone-top-actions">
              <div class="zone-h2">配送区域 Zone 管理</div>
              <button class="zone-btn zone-back" id="btnBack" title="返回后台">← 返回</button>
            </div>

            <div class="zone-row">
              <label>Zone ID（唯一，比如 zone_freshmeadows）</label>
              <input id="zoneId" placeholder="zone_freshmeadows" autocomplete="off" />
            </div>
              <div class="zone-row">
  <label>Zone 名称</label>
  <input id="zoneName" placeholder="例如：贝赛/小颈地区" autocomplete="off" />
</div>

            <div class="zone-row">
  <label>Zip（必填，用逗号或换行分隔，如 11365,11366）</label>

  <textarea
    id="zoneZips"
    placeholder="11365,11366&#10;11361&#10;11364"
    autocomplete="postal-code"
    style="min-height:110px;"
  ></textarea>

  <div class="zone-hint" style="margin-top:8px;">
    ZIP 模式说明：<br/>
    - 支持：逗号 / 空格 / 换行<br/>
    - 每行一个 ZIP 最稳<br/>
    - 系统会自动去重并校验 5 位 ZIP
  </div>
</div>
            <div class="zone-row">
              <label>备注（可选）</label>
              <textarea id="zoneNote" placeholder="例如：周五 5-9PM 配送"></textarea>
            </div>
            <!-- ✅ 新增：配送星期 / 截单时间 -->
<div class="zone-row">
  <label>配送星期（0=周日 … 6=周六）</label>
  <select id="zoneDeliveryDay">
    <option value="">（不设置）</option>
    <option value="0">周日 (0)</option>
    <option value="1">周一 (1)</option>
    <option value="2">周二 (2)</option>
    <option value="3">周三 (3)</option>
    <option value="4">周四 (4)</option>
    <option value="5">周五 (5)</option>
    <option value="6">周六 (6)</option>
  </select>
  <div class="zone-hint" style="margin-top:8px;">
    建议：新鲜草原=周五(5)，白石镇/大学点=周六(6)，贝赛/小颈=周日(0)
  </div>
</div>

<div class="zone-row">
  <label>截单时间（例如 23:59）</label>
  <input id="zoneCutoffTime" placeholder="23:59" autocomplete="off" />
</div>
<!-- ✅ 新增：区域团成团统计（真实+虚假展示） -->
<div class="zone-row">
  <label>已拼单虚假加成（fakeJoinedOrders）</label>
  <input
    id="zoneFakeJoinedOrders"
    type="number"
    min="0"
    step="1"
    placeholder="例如：20（会在前台已拼单数上加 20）"
    autocomplete="off"
  />
  <div class="zone-hint" style="margin-top:8px;">
    前台显示：已拼 = 真实订单数 + 虚假加成（fakeJoinedOrders）
  </div>
</div>

<div class="zone-row">
  <label>成团目标（needOrders）</label>
  <input
    id="zoneNeedOrders"
    type="number"
    min="1"
    step="1"
    placeholder="例如：50"
    autocomplete="off"
  />
  <div class="zone-hint" style="margin-top:8px;">
    前台显示：还差 = needOrders - 已拼
  </div>
</div>
            <div class="zone-btns">
              <button class="zone-btn primary" id="btnSave">保存 / 更新</button>
              <button class="zone-btn ghost" id="btnNew">新建模式</button>
              <!-- ❌ ZIP-only：移除清除多边形按钮 -->
              <!-- <button class="zone-btn ghost" id="btnClearPoly">清除当前多边形</button> -->
            </div>

            <div class="zone-hint">
              操作：<br/>
              1) 填 Zone ID + Zone 名称<br/>
              2) 填 ZIP（逗号分隔）<br/>
              3) 点“保存/更新”写入数据库<br/>
              4) 在下方列表点“编辑”，可回填并更新 ZIP
            </div>

            <div class="zone-list">
              <div class="zone-h2" style="font-size:14px;">已保存 Zones</div>
              <div id="zonesList"></div>
            </div>
          </div>

          <!-- 右：ZIP-only 提示面板（不加载地图） -->
          <div class="zone-right">
            <div class="zip-only-panel">
              <div class="zip-only-card">
                <h3 class="zip-only-title">ZIP-only 模式已启用</h3>
                <p class="zip-only-desc">
                  为了避免 Google 地图 Key/限制导致后台功能不可用，本页面已关闭地图加载。
                  你仍然可以正常新增/编辑/删除 Zone 的 ZIP 白名单。
                </p>
                <ul class="zip-only-list">
                  <li>前台判断配送：通过 <code>/api/zones/by-zip?zip=xxxxx</code> 命中 Zone.zips</li>
                  <li>建议：每个 Zone 放一组相邻 ZIP，方便你后续扩区</li>
                  <li>如果你以后想恢复地图，再把 maps script 加回来即可</li>
                </ul>
                <div class="zip-only-badge">✅ 不加载地图也能编辑保存</div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <!-- ✅ 登录保护 / UI -->
  <script src="/admin/assets/js/admin_guard.js"></script>
  <script src="./assets/js/admin_auth_ui.js"></script>

  <!-- ✅ sidebar 注入 -->
  <script src="/admin/assets/js/admin_sidebar.js"></script>
  <script src="assets/js/admin.js"></script>

  <!-- ✅ 业务逻辑脚本（注意：你需要把 admin_zones.js 改成 ZIP-only，不要再依赖地图） -->
  <script src="./assets/js/admin_zones.js"></script>

  <!-- ✅ 返回后台：支持 ?back=xxx（不传则默认 dashboard.html） -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("btnBack");
      const topBack = document.getElementById("btnBackTop");
      const qs = new URLSearchParams(location.search);
      const back = qs.get("back") || "dashboard.html";

      if (btn) btn.addEventListener("click", () => (window.location.href = back));
      if (topBack) topBack.setAttribute("href", back);
    });
  </script>
</body>
</html>
