<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>充值成功 - Freshbuy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KP7J1LKVFJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KP7J1LKVFJ');
</script>
  <link rel="stylesheet" href="./assets/css/main.css" />
  <style>
    body{background:#f3f4f6;}
    .box{
      max-width:520px;margin:30px auto;background:#fff;border-radius:18px;
      padding:22px;box-shadow:0 8px 26px rgba(0,0,0,.08);
      text-align:center;
    }
    .ok{
      width:72px;height:72px;border-radius:50%;
      background:#22c55e;color:#fff;display:flex;align-items:center;justify-content:center;
      margin:6px auto 14px;font-size:34px;font-weight:900;
    }
    h1{margin:0 0 10px;font-size:20px;color:#111827;}
    p{margin:0 0 16px;color:#64748b;font-size:14px;line-height:1.6;}
    .row{
      margin:14px 0 6px;
      padding:14px 14px;
      border:2px solid #e5e7eb;
      border-radius:14px;
      background:#f9fafb;
      text-align:left;
    }
    .row .label{font-size:12px;color:#64748b;margin-bottom:6px;}
    .row .val{font-size:20px;font-weight:900;color:#111827;}
    .muted{font-size:12px;color:#64748b;margin-top:10px;}
    .btn{
      display:block;width:100%;
      border:0;border-radius:999px;
      padding:14px 12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#fff;font-weight:900;font-size:16px;
      cursor:pointer;
      margin-top:10px;
    }
    .btn-ghost{
      background:#eef2ff;color:#111827;
    }
    .spin{
      display:inline-block;
      width:14px;height:14px;
      border:2px solid rgba(0,0,0,.15);
      border-top-color: rgba(0,0,0,.55);
      border-radius:50%;
      animation: s 0.8s linear infinite;
      vertical-align:-2px;
      margin-right:6px;
    }
    @keyframes s { to { transform: rotate(360deg);} }
    .small{
      font-size:12px;color:#64748b;margin-top:12px;line-height:1.5;
      text-align:left;background:#f8fafc;border:1px dashed #e5e7eb;border-radius:12px;padding:10px 12px;
    }
    .tag{
      display:inline-block;font-size:12px;font-weight:800;
      padding:4px 10px;border-radius:999px;
      background:#ecfdf5;color:#15803d;border:1px solid #bbf7d0;
      margin-top:6px;
    }
    .tag-warn{
      background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;
    }
  </style>
</head>
<body>
  <div class="box">
    <div class="ok">✓</div>
    <h1>充值已完成</h1>
    <p>我们正在为你刷新账户余额。若余额未立刻更新，可能正在入账处理中，请稍后再刷新一次。</p>

    <div class="row">
      <div class="label">当前账户余额</div>
      <div class="val" id="balText"><span class="spin"></span>加载中…</div>
      <div class="muted" id="balHint"></div>
      <div id="stateTag" class="tag" style="display:none;"></div>
    </div>

    <button class="btn" id="btnRefresh">手动刷新余额</button>
    <button class="btn btn-ghost" onclick="goRecharge()">返回充值页</button>
    <button class="btn btn-ghost" onclick="goHome()">返回首页</button>

    <div class="small">
      <b>提示：</b>
      Stripe 支付成功后，余额需要后端 webhook 入账才能增加。若你已部署 webhook 仍未更新，通常是：
      <br/>1) 成功页调用的余额接口不是你真实接口
      <br/>2) token 不对/没登录
      <br/>3) webhook 没命中或 STRIPE_WEBHOOK_SECRET 不匹配（test/live）
    </div>
  </div>

<script>
  // ===== 兼容取 token：优先 Auth.getToken，其次 localStorage.token =====
  function getToken() {
    try {
      if (window.Auth && typeof Auth.getToken === "function") return Auth.getToken() || "";
    } catch (e) {}
    return localStorage.getItem("token") || "";
  }

  function fmtMoney(n){
    const x = Number(n || 0);
    return "$" + x.toFixed(2);
  }

  // 解析余额（兼容多个字段结构）
  function pickBalance(data){
    if (!data || typeof data !== "object") return null;

    // 常见字段
    if (typeof data.balance === "number") return data.balance;
    if (typeof data.walletBalance === "number") return data.walletBalance;

    // wallet: { balance }
    if (data.wallet && typeof data.wallet.balance === "number") return data.wallet.balance;

    // me: { wallet: { balance } }
    if (data.me && data.me.wallet && typeof data.me.wallet.balance === "number") return data.me.wallet.balance;

    // user: { walletBalance }
    if (data.user && typeof data.user.walletBalance === "number") return data.user.walletBalance;

    return null;
  }

  // 尝试多个接口，哪个返回了 balance 就用哪个
  const BALANCE_ENDPOINTS = [
    "/api/wallet/me",
    "/api/wallet/my",
    "/api/wallet/balance",
    "/api/users/me",
  ];

  const balText = document.getElementById("balText");
  const balHint = document.getElementById("balHint");
  const stateTag = document.getElementById("stateTag");
  const btnRefresh = document.getElementById("btnRefresh");

  let lastBalance = null;

  function setTag(type, text){
    stateTag.style.display = "inline-block";
    stateTag.className = "tag" + (type === "warn" ? " tag-warn" : "");
    stateTag.textContent = text;
  }

  async function fetchBalanceOnce(){
    const token = getToken();
    if (!token) throw new Error("未登录（缺少 token）");

    for (const url of BALANCE_ENDPOINTS) {
      try {
        const res = await fetch(url, {
          headers: { Authorization: "Bearer " + token }
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) continue;

        const bal = pickBalance(data);
        if (typeof bal === "number") {
          return { bal, from: url, raw: data };
        }
      } catch (e) {
        // 单个接口失败就尝试下一个
      }
    }
    throw new Error("未从任何余额接口获取到 balance（请确认后端余额接口）");
  }

  async function loadBalance(){
    const token = getToken();
    if (!token) {
      balText.textContent = "未登录";
      balHint.textContent = "请先登录后查看余额。";
      setTag("warn", "需要登录");
      return;
    }

    balText.innerHTML = '<span class="spin"></span>加载中…';
    balHint.textContent = "";
    stateTag.style.display = "none";

    try{
      const out = await fetchBalanceOnce();
      const bal = out.bal;

      balText.textContent = fmtMoney(bal);

      if (lastBalance === null) {
        setTag("ok", "已刷新");
        balHint.textContent = "来源接口：" + out.from;
      } else if (bal > lastBalance) {
        setTag("ok", "已入账");
        balHint.textContent = "余额已更新（入账完成）。来源接口：" + out.from;
      } else if (bal === lastBalance) {
        setTag("warn", "入账处理中");
        balHint.textContent = "余额暂未变化，可能 webhook 正在入账处理中，稍后自动再试。来源接口：" + out.from;
      } else {
        setTag("warn", "余额变动");
        balHint.textContent = "余额与上次不同（减少/变化）。来源接口：" + out.from;
      }

      lastBalance = bal;

      // 可选：同步缓存，避免其它页面显示旧值
      try {
        localStorage.setItem("freshbuy_wallet_balance", String(bal));
        localStorage.setItem("wallet_balance", String(bal));
      } catch (e) {}
    } catch(e){
      balText.textContent = "加载失败";
      balHint.textContent = "原因：" + (e.message || "网络错误");
      setTag("warn", "加载失败");
    }
  }

  function goRecharge(){ location.href = "/user/recharge.html"; }
  function goHome(){ location.href = "/user/index.html"; }

  btnRefresh.addEventListener("click", loadBalance);

  // 自动刷新：0s / 2s / 5s / 10s（给 webhook 入账时间）
  loadBalance();
  setTimeout(loadBalance, 2000);
  setTimeout(loadBalance, 5000);
  setTimeout(loadBalance, 10000);
</script>
</body>
</html>
